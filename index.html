<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»è¥åˆ†æå¯è§†åŒ–ç³»ç»Ÿ</title>
    <!-- CSS -->
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* è¦†ç›–æˆ–è¡¥å……ä¸€äº›ç‰¹å®šäºSPAçš„æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Upload Container Styles (from previous index.html) */
        .upload-container-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ebef 100%);
        }

        .upload-box {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            background: rgba(255,255,255,0.5);
        }

        .upload-area:hover {
            border-color: #a02724;
            background: rgba(160, 39, 36, 0.05);
        }

        .btn-upload {
            background: #a02724;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-top: 24px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(160, 39, 36, 0.3);
        }

        /* Hide legacy time filters as they are now drill selectors */
        .filter-section:has(#filter-year),
        .filter-section:has(#filter-week-start) {
            display: none;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- ä¸Šä¼ ç•Œé¢ -->
    <div class="upload-container-wrapper" id="uploadContainer">
        <div class="upload-box">
            <h1 style="color:#a02724;margin-bottom:8px;">ç»è¥åˆ†æå¯è§†åŒ–ç³»ç»Ÿ</h1>
            <p style="color:#666;font-size:14px;">æ”¯æŒ CSV / Excel / JSON æ•°æ®å¯¼å…¥</p>
            
            <form id="uploadForm">
                <div class="upload-area" id="dropZone" style="position:relative;">
                    <span style="font-size:48px;display:block;margin-bottom:16px;">ğŸ“‚</span>
                    <span id="uploadText">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</span>
                    <input type="file" name="file" id="fileInput" accept=".csv, .xlsx, .xls, .json" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:1;" required>
                </div>

                <div id="fileInfo" style="margin-top:16px;font-size:14px;color:#333;display:none;"></div>
                <div id="errorMsg" style="color:#e74c3c;margin-top:16px;font-size:14px;display:none;"></div>

                <button type="submit" class="btn-upload" id="submitBtn" style="display:none;position:relative;z-index:10;">å¼€å§‹åˆ†æ</button>
                
                <div id="loading" style="display:none;margin-top:20px;color:#666;">
                    æ­£åœ¨å¤„ç†æ•°æ®...
                </div>
            </form>
        </div>
    </div>

    <!-- ä»ªè¡¨ç›˜å®¹å™¨ (åˆå§‹éšè—) -->
    <div id="dashboardContainer" style="display:none;">
        <!-- PPTé¡µé¢ä¸»ä½“æ¡†æ¶ -->
        <div class="ppt-container">
            <div class="header">
                <h1 id="mainTitle">å››å·åˆ†å…¬å¸è½¦é™©ç»è¥åˆ†æ</h1>
                <div class="header-info" id="reportDate">æ•°æ®æˆªæ­¢æ—¥æœŸï¼š--</div>
            </div>



        <!-- å…ƒæ•°æ®é¢„è§ˆå¡ç‰‡ -->
        <div id="metadata-card" class="metadata-preview" style="display: none;">
            <div class="metadata-item">
                <span class="metadata-label">ğŸ“… ä¿å•å¹´åº¦</span>
                <span class="metadata-value" id="meta-year">-</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ğŸ“Š å‘¨æ¬¡</span>
                <span class="metadata-value" id="meta-week">-</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ğŸ• æ›´æ–°æ—¥æœŸ</span>
                <span class="metadata-value" id="meta-update-date">-</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ğŸ“ åˆ†ææ¨¡å¼</span>
                <span class="metadata-badge" id="meta-mode">-</span>
            </div>
            <div class="metadata-item">
                <span class="metadata-label">ğŸ¢ æœºæ„æ•°é‡</span>
                <span class="metadata-value" id="meta-org-count">-</span>
            </div>
            <div class="metadata-item" id="meta-org-list-container" style="display: none;">
                <span class="metadata-label">ğŸ“‹ æœºæ„åˆ—è¡¨</span>
                <span class="metadata-value-small" id="meta-org-list">-</span>
            </div>
        </div>

        <!-- å…¨å±€ç­›é€‰æ§åˆ¶åŒº -->
        <div class="filter-control-bar">
            <!-- é‡ç½®æŒ‰é’®ç§»åˆ°æœ€å‰é¢ -->
            <div class="filter-section">
                <button id="btn-reset-filters" class="filter-btn filter-btn-reset">é‡ç½®</button>
            </div>

            <div class="filter-section">
                <span class="filter-label">å¹´åº¦</span>
                <select id="filter-year" class="filter-select">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>

            <div class="filter-section">
                <span class="filter-label">å‘¨æ¬¡èŒƒå›´</span>
                <input type="number" id="filter-week-start" class="filter-input" placeholder="èµ·å§‹" min="1" max="52" value="1" style="width: 45px;">
                <span>-</span>
                <input type="number" id="filter-week-end" class="filter-input" placeholder="ç»“æŸ" min="1" max="52" value="52" style="width: 45px;">
            </div>

            <!-- ç”µå•†å¼ä¸‹æ‹‰ç­›é€‰åŒº -->
            <div class="drill-selector-section">
                <div class="drill-selectors" id="drill-selectors">
                    <!-- åŠ¨æ€ç”Ÿæˆä¸‹æ‹‰é€‰æ‹©å™¨ -->
                </div>
            </div>

            <!-- å·²é€‰æ¡ä»¶æ ‡ç­¾åŒº (å·²ç§»é™¤ï¼Œæ•´åˆè‡³æŒ‰é’®) -->
            <!-- <div class="drill-tags-section"> ... </div> -->
        </div>

        <!-- ä¸‹æ‹‰é€‰æ‹©å™¨çš„ä¸‹æ‹‰é¢æ¿ï¼ˆå…±ç”¨ï¼‰ -->
        <div id="drill-dropdown-panel" class="drill-dropdown-panel" style="display: none;">
            <div class="drill-dropdown-search">
                <input type="text" id="drill-search-input" placeholder="æœç´¢..." />
            </div>
            <div class="drill-dropdown-actions">
                <button class="drill-action-btn" onclick="Dashboard.toggleAllInDropdown('all')">å…¨é€‰</button>
                <button class="drill-action-btn" onclick="Dashboard.toggleAllInDropdown('invert')">åé€‰</button>
                <button class="drill-action-btn" onclick="Dashboard.toggleAllInDropdown('none')">æ¸…ç©º</button>
                <button class="drill-action-btn primary" onclick="Dashboard.applyDrillFilters()">ç¡®å®š</button>
            </div>
            <div class="drill-dropdown-list" id="drill-dropdown-list">
                <!-- åŠ¨æ€ç”Ÿæˆcheckboxåˆ—è¡¨ -->
            </div>
        </div>

        <!-- æ‚¬æµ®ä¸Šä¼ æŒ‰é’® -->
        <div class="float-btn" onclick="location.reload()" title="å¯¼å…¥æ–°æ•°æ®">
            <svg viewBox="0 0 24 24">
                <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="overview" tabindex="0">ç»è¥æ¦‚è§ˆ</div>
            <div class="tab" data-tab="premium" tabindex="0">ä¿è´¹è¿›åº¦</div>
            <div class="tab" data-tab="cost" tabindex="0">å˜åŠ¨æˆæœ¬</div>
            <div class="tab" data-tab="loss" tabindex="0">æŸå¤±æš´éœ²</div>
            <div class="tab" data-tab="expense" tabindex="0">è´¹ç”¨æ”¯å‡º</div>
        </div>

        <div class="content">
            <div id="error-banner" class="error-banner"></div>
        
            <!-- ç»è¥æ¦‚è§ˆ -->
            <div id="tab-overview" class="tab-content active">
                <div class="dimension-switch">
                    <button class="dimension-btn active" onclick="Dashboard.switchDimension('overview', 'kpi', this)">KPI</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('overview', 'org', this)">ä¸‰çº§æœºæ„</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('overview', 'category', this)">å®¢æˆ·ç±»åˆ«</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('overview', 'businessType', this)">ä¸šåŠ¡ç±»å‹</button>
                </div>

                <div id="overview-kpi-content">
                    <!-- KPIé‡ç‚¹æç¤ºæ ‡é¢˜ -->
                    <div id="kpi-alert-title" class="kpi-alert-title" style="display: none;"></div>

                    <div class="metric-cards">
                        <div class="metric-card"><div class="metric-label">ä¿è´¹æ—¶é—´è¿›åº¦è¾¾æˆç‡</div><div class="metric-value" id="metric-progress">--<span class="metric-unit">%</span></div></div>
                        <div class="metric-card"><div class="metric-label">å˜åŠ¨æˆæœ¬ç‡</div><div class="metric-value" id="metric-cost-rate">--<span class="metric-unit">%</span></div></div>
                        <div class="metric-card"><div class="metric-label">æ»¡æœŸèµ”ä»˜ç‡</div><div class="metric-value" id="metric-claim-rate">--<span class="metric-unit">%</span></div></div>
                        <div class="metric-card"><div class="metric-label">è´¹ç”¨ç‡</div><div class="metric-value" id="metric-expense-rate">--<span class="metric-unit">%</span></div></div>
                        <div class="metric-card"><div class="metric-label">ç­¾å•ä¿è´¹</div><div class="metric-value" id="metric-premium">--<span class="metric-unit">ä¸‡å…ƒ</span></div></div>
                        <div class="metric-card"><div class="metric-label">è¾¹é™…è´¡çŒ®é¢</div><div class="metric-value" id="metric-margin">--<span class="metric-unit">ä¸‡å…ƒ</span></div></div>
                        <div class="metric-card"><div class="metric-label">å·²æŠ¥å‘Šèµ”æ¬¾</div><div class="metric-value" id="metric-claim">--<span class="metric-unit">ä¸‡å…ƒ</span></div></div>
                        <div class="metric-card"><div class="metric-label">è´¹ç”¨é‡‘é¢</div><div class="metric-value" id="metric-expense">--<span class="metric-unit">ä¸‡å…ƒ</span></div></div>
                    </div>
                </div>

                <div id="overview-chart-content" style="display:none;">
                    <!-- ä¸»é¢˜æç¤º -->
                    <div id="overview-alert-title" class="section-alert-title" style="display: none;">
                        <span class="alert-icon">âš ï¸</span>
                        <span class="alert-text"></span>
                    </div>

                    

                    <!-- å›¾è¡¨å®¹å™¨ -->
                    <div class="chart-container"><div id="chart-overview" class="chart chart-standard"></div></div>

                    <!-- æ­£æ–‡åˆ†æ -->
                    <div id="overview-analysis-content" class="analysis-content" style="display: none;">
                        <ul id="overview-analysis-list" class="analysis-list"></ul>
                    </div>
                </div>
            </div>

            <!-- ä¿è´¹è¿›åº¦ -->
            <div id="tab-premium" class="tab-content">
                <div class="dimension-switch">
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('premium', 'org', this)">ä¸‰çº§æœºæ„</button>
                    <button class="dimension-btn active" onclick="Dashboard.switchDimension('premium', 'category', this)">å®¢æˆ·ç±»åˆ«</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('premium', 'businessType', this)">ä¸šåŠ¡ç±»å‹</button>
                </div>
                <!-- ä¸»é¢˜æç¤º -->
                <div id="premium-alert-title" class="section-alert-title" style="display: none;">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-text"></span>
                </div>
                <div class="chart-container"><div id="chart-premium" class="chart"></div></div>
            </div>

            <!-- å˜åŠ¨æˆæœ¬ -->
            <div id="tab-cost" class="tab-content">
                <div class="dimension-switch">
                    <button class="dimension-btn active" onclick="Dashboard.switchDimension('cost', 'org', this)">ä¸‰çº§æœºæ„</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('cost', 'category', this)">å®¢æˆ·ç±»åˆ«</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('cost', 'businessType', this)">ä¸šåŠ¡ç±»å‹</button>
                </div>
                <!-- ä¸»é¢˜æç¤º -->
                <div id="cost-alert-title" class="section-alert-title" style="display: none;">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-text"></span>
                </div>
                <div class="chart-container"><div id="chart-cost" class="chart"></div></div>
            </div>

            <!-- æŸå¤±æš´éœ² -->
            <div id="tab-loss" class="tab-content">
                <div class="dimension-switch">
                    <button class="dimension-btn active" onclick="Dashboard.switchDimension('loss', 'org', this)">ä¸‰çº§æœºæ„</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('loss', 'category', this)">å®¢æˆ·ç±»åˆ«</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('loss', 'businessType', this)">ä¸šåŠ¡ç±»å‹</button>
                </div>
                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="bubble" onclick="Dashboard.switchSubTab('loss', 'bubble', this)">èµ”ä»˜ç‡VSå æ¯”</button>
                    <button class="sub-tab" data-subtab="quadrant" onclick="Dashboard.switchSubTab('loss', 'quadrant', this)">é¢‘åº¦VSé¢åº¦</button>
                </div>
                <!-- ä¸»é¢˜æç¤º -->
                <div id="loss-alert-title" class="section-alert-title" style="display: none;">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-text"></span>
                </div>

                <div class="chart-container"><div id="chart-loss" class="chart"></div></div>
            </div>

            <!-- è´¹ç”¨æ”¯å‡º -->
            <div id="tab-expense" class="tab-content">
                <div class="dimension-switch">
                    <button class="dimension-btn active" onclick="Dashboard.switchDimension('expense', 'org', this)">ä¸‰çº§æœºæ„</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('expense', 'category', this)">å®¢æˆ·ç±»åˆ«</button>
                    <button class="dimension-btn" onclick="Dashboard.switchDimension('expense', 'businessType', this)">ä¸šåŠ¡ç±»å‹</button>
                </div>
                <!-- ä¸»é¢˜æç¤º -->
                <div id="expense-alert-title" class="section-alert-title" style="display: none;">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-text"></span>
                </div>

                <!-- è´¹ç”¨é‡‘é¢VSè´¹ç”¨ç‡å›¾è¡¨ -->
                <div class="chart-container"><div id="chart-expense" class="chart"></div></div>

                <!-- è´¹ç”¨è¶…æ”¯åˆ†æå›¾è¡¨ -->
                <div class="chart-container">
                    <h3 class="chart-title">è´¹ç”¨è¶…æ”¯åˆ†æ</h3>
                    <div id="chart-expense-surplus" class="chart"></div>
                </div>
            </div>
        </div>
        </div> <!-- ç»“æŸ ppt-container -->
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <script src="js/static-report-generator.js"></script>
    <script src="js/dashboard.js"></script>
    
    <script>
        // Main Entry Point
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitBtn');
        const dropZone = document.getElementById('dropZone');
        const uploadForm = document.getElementById('uploadForm');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');
        const fileInfo = document.getElementById('fileInfo');

        let appController = null;
        try {
            appController = new StaticReportGenerator(); // We can rename this class later
        } catch (e) {
            console.error('Failed to init controller:', e);
            errorMsg.textContent = 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
            errorMsg.style.display = 'block';
        }

        // å¤„ç†URLå‚æ•°è‡ªåŠ¨åŠ è½½æ•°æ®
        function loadFileFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get('file');
            if (fileName) {
                console.log('æ£€æµ‹åˆ°æ–‡ä»¶å‚æ•°:', fileName);
                // å°è¯•é€šè¿‡fetchåŠ è½½æ–‡ä»¶
                fetch(`./${encodeURIComponent(fileName)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const file = new File([blob], fileName, { type: 'text/csv' });
                        console.log('æ–‡ä»¶åŠ è½½æˆåŠŸ:', fileName);
                        
                        // åˆ›å»ºDataTransferå¯¹è±¡æ¥æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        
                        fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
                        fileInfo.style.display = 'block';
                        document.getElementById('uploadText').textContent = file.name;
                        submitBtn.style.display = 'block';
                        errorMsg.style.display = 'none';
                        fileInput.style.pointerEvents = 'none';
                        
                        // è‡ªåŠ¨æäº¤å¤„ç†
                        submitBtn.click();
                    })
                    .catch(err => {
                        console.error('URLæ–‡ä»¶åŠ è½½å¤±è´¥:', err);
                        errorMsg.textContent = 'URLä¸­çš„æ–‡ä»¶åŠ è½½å¤±è´¥: ' + err.message;
                        errorMsg.style.display = 'block';
                    });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå°è¯•ä»URLåŠ è½½æ–‡ä»¶
        loadFileFromURL();

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                document.getElementById('uploadText').textContent = file.name;
                submitBtn.style.display = 'block';
                errorMsg.style.display = 'none';
                // ç¦ç”¨ fileInput çš„ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢é˜»æŒ¡æäº¤æŒ‰é’®
                fileInput.style.pointerEvents = 'none';
            }
        });

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#a02724';
            dropZone.style.background = 'rgba(160, 39, 36, 0.05)';
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = 'rgba(255,255,255,0.5)';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = 'rgba(255,255,255,0.5)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = fileInput.files[0];
            if (!file) return;

            loading.style.display = 'block';
            submitBtn.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                // Load Data via Controller
                const data = await appController.loadData(file, (msg) => {
                    loading.textContent = msg;
                });

                // Initialize Dashboard
                Dashboard.init(data, appController.worker);

            } catch (err) {
                console.error(err);
                errorMsg.textContent = 'å¤„ç†å¤±è´¥: ' + err.message;
                errorMsg.style.display = 'block';
                loading.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        });
    </script>
</body>
</html>
