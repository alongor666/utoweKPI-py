# 费用支出板块投产分析图详细设计方案

> 版本: 2.0
> 更新时间: 2025-12-22
> 设计目标: 提供费用投入效率的多维度分析工具

---

## 一、需求概述

### 业务背景
在费用支出管理中,不仅要关注费用金额和费用率,更要关注**费用投入的产出效率**:
- 每一元费用能产出多少保费?
- 每一元费用能产生多少实际净收益?
- 不同机构/客户类别/业务类型的投产效率如何?

### 核心需求
在费用支出板块新增**投产效率分析图**,展示三个关键指标:
1. **费用产出保费比**: 每1元费用投放产出多少签单保费
2. **费用产出边际贡献**: 每1元费用产生多少边际贡献额(净收益)
3. **边际贡献率**: 保费中扣除变动成本后的利润空间

支持**三级机构/客户类别/业务类型**三个维度的动态切换。

---

## 二、指标体系设计

### 1. 费用产出保费比

**定义**: 每投入1元费用,产出多少签单保费

**计算公式**:
```
费用产出保费比 = 签单保费 / 费用额
```

**单位**: 元/元 (显示为 "X.XX元")

**业务含义**:
- 反映费用投入的直接产出效率
- 数值越高,说明费用使用效率越高
- 典型值: 3-10元 (行业平均约5-6元)

**预警阈值建议**:
- 优秀: ≥ 6元
- 良好: 4-6元
- 警告: 3-4元
- 危险: < 3元

---

### 2. 费用产出边际贡献

**定义**: 每投入1元费用,产生多少边际贡献额(扣除变动成本后的净收益)

**计算公式**:
```
边际贡献额 = 签单保费 × (1 - 已报告赔款/满期保费 + 费用金额/签单保费)

简化展开：
边际贡献额 = 签单保费 - 签单保费 × (已报告赔款/满期保费) + 费用金额

费用产出边际贡献 = 边际贡献额 / 费用额
```

**⚠️ 重要说明**:
- 这是车险业务的标准边际贡献计算规则
- 已报告赔款/满期保费 = 满期赔付率（变动成本率）
- 费用金额在此公式中加回，因其已在分母中单独考核

**单位**: 元/元 (显示为 "X.XX元")

**业务含义**:
- 反映费用投入的实际盈利能力
- 考虑了赔付成本,是真实的净收益产出
- 该指标直接关联到公司利润
- 典型值: 0.5-2.5元

**预警阈值建议**:
- 优秀: ≥ 2元
- 良好: 1-2元
- 警告: 0.5-1元
- 危险: < 0.5元 (边际亏损)

**特殊情况处理**:
- 负值: 说明该维度的业务变动成本率过高,费用投入产生亏损
- 显示为红色加粗,需要重点关注

---

### 3. 边际贡献率

**定义**: 保费中扣除变动成本后的利润率

**计算公式**:
```
边际贡献率 = (边际贡献额 / 签单保费) × 100
```

**单位**: % (显示为 "XX.X%")

**业务含义**:
- 反映业务的盈利空间
- 与费用投入效率结合,综合评估业务质量
- 边际贡献率高 + 费用产出比高 = **黄金业务**
- 典型值: 10%-30%

**预警阈值建议**:
- 优秀: ≥ 25%
- 良好: 15%-25%
- 警告: 10%-15%
- 危险: < 10%

---

## 三、图表设计

### 1. 图表类型

**组合图 (Combo Chart)**:
- **左Y轴**: 费用产出比 (并列柱状图)
  - 柱1: 费用产出保费比 (深蓝色)
  - 柱2: 费用产出边际贡献 (深绿色)
- **右Y轴**: 边际贡献率 (折线图,深红色)
- **X轴**: 按选定维度展示 (机构/客户类别/业务类型)

### 2. 配色方案

遵循项目麦肯锡风格配色规范:

| 元素 | 颜色 | Hex | 说明 |
|-----|------|-----|------|
| 费用产出保费比 | 深蓝色 | `#0070c0` | 柱1,代表保费产出 |
| 费用产出边际贡献 | 深绿色 | `#00b050` | 柱2,代表净收益产出 |
| 边际贡献率折线 | 深红色 | `#c00000` | 折线,代表盈利质量 |
| 目标预警线 | 黄色虚线 | `#ffc000` | 边际贡献率目标值(可选) |
| 数据标签 | 黑色 | `#000000` | 柱状图顶部数值 |

### 3. 视觉结构示意图

```
┌─────────────────────────────────────────────────────────────┐
│  投产效率分析                                                 │
│  [三级机构 ▾] [客户类别] [业务类型]                          │
├─────────────────────────────────────────────────────────────┤
│  费用产出比(元)                                  边际贡献率(%) │
│   ↑                                                       ↑  │
│  8│                                                    25%│  │
│   │  ▓▓  ▒▒                                               │  │
│  6│  ▓▓  ▒▒        ▓▓  ▒▒                                │  │
│   │  ▓▓  ▒▒  ─●─  ▓▓  ▒▒  ─●─                          15%│  │
│  4│  ▓▓  ▒▒        ▓▓  ▒▒                                │  │
│   │  ▓▓  ▒▒        ▓▓  ▒▒                                │  │
│  2│  ▓▓  ▒▒        ▓▓  ▒▒                              5%│  │
│   └──┴───┴─────────┴───┴──────────────────────────────────┘  │
│     天府          新都          高新                          │
│                                                              │
│  ▓▓ 费用产出保费比    ▒▒ 费用产出边际贡献    ─●─ 边际贡献率  │
└─────────────────────────────────────────────────────────────┘
```

### 4. 数据标签规范

**柱状图标签**:
- 位置: 柱子顶部
- 格式: 保留2位小数 ("5.23")
- 颜色: 黑色加粗 (`#000000`, `font-weight: bold`)
- 字体大小: 11px

**折线图标签**:
- 位置: 数据点上方
- 格式: 保留1位小数 + 百分号 ("18.5%")
- 颜色: 深红色 (`#c00000`)
- 字体大小: 11px

### 5. 交互提示框 (Tooltip)

```javascript
tooltip: {
  trigger: 'axis',
  axisPointer: { type: 'cross' },
  formatter: (params) => {
    const dimension = params[0].axisValue;
    const p1 = params[0]; // 费用产出保费比
    const p2 = params[1]; // 费用产出边际贡献
    const p3 = params[2]; // 边际贡献率

    return `
      <div style="padding: 8px;">
        <strong style="font-size: 14px;">${dimension}</strong><br/>
        <hr style="margin: 5px 0; border-color: #ddd;"/>
        <div style="margin-top: 5px;">
          <span style="display:inline-block; width:12px; height:12px; background:#0070c0; margin-right:5px;"></span>
          费用产出保费比: <strong>${p1.value.toFixed(2)}元</strong><br/>
          <span style="display:inline-block; width:12px; height:12px; background:#00b050; margin-right:5px;"></span>
          费用产出边际贡献: <strong>${p2.value.toFixed(2)}元</strong><br/>
          <span style="display:inline-block; width:12px; height:12px; background:#c00000; margin-right:5px;"></span>
          边际贡献率: <strong>${p3.value.toFixed(1)}%</strong>
        </div>
      </div>
    `;
  }
}
```

---

## 四、数据处理逻辑

### 1. 维度字段映射

```javascript
const roiDimensionMapping = {
  'org': 'third_level_organization',       // 三级机构
  'category': 'customer_category_3',       // 客户类别
  'businessType': 'ui_short_label'         // 业务类型
};
```

### 2. 数据聚合流程

**步骤1: 数据分组**
```javascript
// 按选定维度对原始数据进行分组
const groups = {};
data.forEach(row => {
  const dimValue = row[dimensionField];
  if (!groups[dimValue]) {
    groups[dimValue] = {
      签单保费: 0,
      费用额: 0,
      满期保费: 0,
      已报告赔款: 0
    };
  }
  groups[dimValue].签单保费 += parseFloat(row.签单保费 || 0);
  groups[dimValue].费用额 += parseFloat(row.费用额 || 0);
  groups[dimValue].满期保费 += parseFloat(row.满期保费 || 0);
  groups[dimValue].已报告赔款 += parseFloat(row.已报告赔款 || 0);
});
```

**步骤2: 计算投产指标**
```javascript
const roiData = Object.entries(groups).map(([name, data]) => {
  // 计算边际贡献额（车险业务标准公式）
  // 公式: 边际贡献额 = 签单保费 × (1 - 已报告赔款/满期保费 + 费用金额/签单保费)
  let 边际贡献额 = 0;
  if (data.签单保费 > 0 && data.满期保费 > 0) {
    const 满期赔付率 = data.已报告赔款 / data.满期保费;
    const 费用率 = data.费用额 / data.签单保费;
    边际贡献额 = data.签单保费 * (1 - 满期赔付率 + 费用率);
  }

  return {
    维度值: name,
    签单保费: data.签单保费,
    费用额: data.费用额,

    // 核心指标
    费用产出保费比: data.费用额 > 0
      ? data.签单保费 / data.费用额
      : 0,

    费用产出边际贡献: data.费用额 > 0
      ? 边际贡献额 / data.费用额
      : 0,

    边际贡献率: data.签单保费 > 0
      ? (边际贡献额 / data.签单保费) * 100
      : 0
  };
});
```

**步骤3: 排序**
```javascript
// 按费用额降序排列
roiData.sort((a, b) => b.费用额 - a.费用额);
```

**步骤4: 异常值处理**
```javascript
// 过滤掉费用额为0或异常值
const validData = roiData.filter(item => {
  return item.费用额 > 0 && item.签单保费 > 0;
});
```

### 3. 数据结构示例

```javascript
// Worker 返回的投产分析数据结构
const roiChartData = {
  dimension: 'org',  // 当前维度
  data: [
    {
      维度值: '天府',
      签单保费: 12500000,
      费用额: 2400000,
      费用产出保费比: 5.21,
      费用产出边际贡献: 1.35,
      边际贡献率: 18.5
    },
    {
      维度值: '新都',
      签单保费: 9800000,
      费用额: 2100000,
      费用产出保费比: 4.67,
      费用产出边际贡献: 0.95,
      边际贡献率: 15.2
    },
    // ... 更多维度数据
  ]
};
```

---

## 五、ECharts 配置实现

### 1. 完整配置示例

```javascript
// 投产分析图表配置
function getROIChartOption(data) {
  return {
    color: ['#0070c0', '#00b050', '#c00000'],

    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross',
        crossStyle: {
          color: '#999'
        }
      },
      formatter: function(params) {
        const dimension = params[0].axisValue;
        const p1 = params[0]; // 费用产出保费比
        const p2 = params[1]; // 费用产出边际贡献
        const p3 = params[2]; // 边际贡献率

        return `
          <div style="padding: 8px;">
            <strong style="font-size: 14px;">${dimension}</strong><br/>
            <hr style="margin: 5px 0; border-color: #ddd;"/>
            <div style="margin-top: 5px;">
              <span style="display:inline-block; width:12px; height:12px; background:#0070c0; margin-right:5px;"></span>
              费用产出保费比: <strong>${p1.value.toFixed(2)}元</strong><br/>
              <span style="display:inline-block; width:12px; height:12px; background:#00b050; margin-right:5px;"></span>
              费用产出边际贡献: <strong>${p2.value.toFixed(2)}元</strong><br/>
              <span style="display:inline-block; width:12px; height:12px; background:#c00000; margin-right:5px;"></span>
              边际贡献率: <strong>${p3.value.toFixed(1)}%</strong>
            </div>
          </div>
        `;
      }
    },

    legend: {
      data: ['费用产出保费比', '费用产出边际贡献', '边际贡献率'],
      top: 10,
      textStyle: {
        fontSize: 12,
        color: '#333'
      }
    },

    grid: {
      left: '5%',
      right: '5%',
      bottom: '15%',
      top: '15%',
      containLabel: true,
      show: false  // 移除网格线
    },

    xAxis: {
      type: 'category',
      data: data.map(item => item.维度值),
      axisLabel: {
        rotate: 45,
        fontSize: 10,
        interval: 0,
        color: '#666',
        // 超长文本截断
        formatter: (value) => {
          return value.length > 8 ? value.substring(0, 8) + '...' : value;
        }
      },
      axisLine: {
        lineStyle: {
          color: '#ccc',
          width: 1
        }
      },
      splitLine: {
        show: false  // 移除网格线
      }
    },

    yAxis: [
      {
        type: 'value',
        name: '费用产出比(元)',
        position: 'left',
        axisLabel: {
          formatter: '{value}',
          color: '#666',
          fontSize: 11
        },
        axisLine: {
          lineStyle: {
            color: '#ccc',
            width: 1
          }
        },
        splitLine: {
          show: false  // 移除网格线
        },
        nameTextStyle: {
          color: '#333',
          fontSize: 12,
          fontWeight: 'bold'
        }
      },
      {
        type: 'value',
        name: '边际贡献率(%)',
        position: 'right',
        axisLabel: {
          formatter: '{value}%',
          color: '#666',
          fontSize: 11
        },
        axisLine: {
          lineStyle: {
            color: '#ccc',
            width: 1
          }
        },
        splitLine: {
          show: false  // 移除网格线
        },
        nameTextStyle: {
          color: '#333',
          fontSize: 12,
          fontWeight: 'bold'
        }
      }
    ],

    series: [
      {
        name: '费用产出保费比',
        type: 'bar',
        yAxisIndex: 0,
        data: data.map(item => item.费用产出保费比),
        barWidth: '18%',
        label: {
          show: true,
          position: 'top',
          formatter: '{c}',
          color: '#000',
          fontSize: 11,
          fontWeight: 'bold'
        },
        itemStyle: {
          color: '#0070c0',
          borderRadius: [4, 4, 0, 0],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 112, 192, 0.3)'
          }
        }
      },
      {
        name: '费用产出边际贡献',
        type: 'bar',
        yAxisIndex: 0,
        data: data.map(item => item.费用产出边际贡献),
        barWidth: '18%',
        label: {
          show: true,
          position: 'top',
          formatter: '{c}',
          color: '#000',
          fontSize: 11,
          fontWeight: 'bold'
        },
        itemStyle: {
          color: '#00b050',
          borderRadius: [4, 4, 0, 0],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 176, 80, 0.3)'
          }
        }
      },
      {
        name: '边际贡献率',
        type: 'line',
        yAxisIndex: 1,
        data: data.map(item => item.边际贡献率),
        label: {
          show: true,
          position: 'top',
          formatter: '{c}%',
          color: '#c00000',
          fontSize: 11
        },
        lineStyle: {
          color: '#c00000',
          width: 1  // 遵循全局规范
        },
        itemStyle: {
          color: '#c00000',
          borderWidth: 2,
          borderColor: '#fff'
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(192, 0, 0, 0.3)'
          }
        },
        // 可选：添加目标预警线
        markLine: {
          silent: false,
          symbol: ['none', 'none'],
          data: [
            {
              yAxis: 20,  // 边际贡献率目标值 20%
              name: '目标线',
              lineStyle: {
                color: '#ffc000',
                type: 'dashed',
                width: 2
              },
              label: {
                show: true,
                position: 'end',
                formatter: '目标: {c}%',
                color: '#ffc000',
                fontSize: 11,
                fontWeight: 'bold'
              }
            }
          ]
        }
      }
    ]
  };
}
```

---

## 六、前端实现方案

### 1. HTML 结构

在 `index.html` 的费用支出板块中添加:

```html
<!-- 投产效率分析图表容器 (在费用超支分析图表之后) -->
<div class="chart-container">
  <div class="chart-header">
    <h3 class="chart-title">投产效率分析</h3>
    <div class="dimension-selector" id="roi-dimension-selector">
      <button class="dimension-btn active" data-dimension="org" data-chart="roi">
        三级机构
      </button>
      <button class="dimension-btn" data-dimension="category" data-chart="roi">
        客户类别
      </button>
      <button class="dimension-btn" data-dimension="businessType" data-chart="roi">
        业务类型
      </button>
    </div>
  </div>
  <div id="chart-roi" class="chart-content" style="height: 500px;"></div>

  <!-- 指标说明 -->
  <div class="chart-legend-info" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
    <div style="font-size: 12px; color: #666;">
      <strong>指标说明:</strong><br/>
      • <span style="color: #0070c0;">█</span> 费用产出保费比: 每1元费用产出的保费金额<br/>
      • <span style="color: #00b050;">█</span> 费用产出边际贡献: 每1元费用产生的净收益(扣除变动成本)<br/>
      • <span style="color: #c00000;">●</span> 边际贡献率: 保费中的利润空间(%)
    </div>
  </div>
</div>
```

### 2. JavaScript 渲染函数

在 `js/dashboard.js` 中添加:

```javascript
/**
 * 渲染投产效率分析图表
 * @param {string} tab - 当前标签页 (应为 'expense')
 */
renderROIChart(tab) {
  if (tab !== 'expense') return;

  console.log('[Dashboard] 开始渲染投产效率分析图表');

  // 获取当前维度
  const dimension = this.currentDimensions.roi || 'org';

  // 向 Worker 请求投产分析数据
  const handler = (e) => {
    if (e.data.type === 'roi_data_complete') {
      const roiData = e.data.payload;
      console.log('[Dashboard] 收到投产分析数据:', roiData);

      // 渲染图表
      this._renderROIChartInternal(roiData);

      // 移除监听器
      this.worker.removeEventListener('message', handler);
    }
  };

  this.worker.addEventListener('message', handler);
  this.worker.postMessage({
    type: 'get_roi_data',
    payload: {
      dimension: this.getDimensionFieldName(dimension),
      filters: this.filterState
    }
  });
}

/**
 * 内部渲染函数
 * @param {Array} roiData - 投产分析数据
 */
_renderROIChartInternal(roiData) {
  // 初始化图表实例
  if (!this.roiChart) {
    const chartDom = document.getElementById('chart-roi');
    if (!chartDom) {
      console.error('[Dashboard] 找不到投产分析图表容器');
      return;
    }
    this.roiChart = echarts.init(chartDom);
  }

  // 数据验证
  if (!roiData || roiData.length === 0) {
    console.warn('[Dashboard] 投产分析数据为空');
    this.roiChart.setOption({
      title: {
        text: '暂无数据',
        left: 'center',
        top: 'center',
        textStyle: {
          color: '#999',
          fontSize: 16
        }
      }
    });
    return;
  }

  // 生成图表配置
  const option = this.getROIChartOption(roiData);

  // 渲染图表
  this.roiChart.setOption(option, true);

  console.log('[Dashboard] 投产效率分析图表渲染完成');
}

/**
 * 切换投产分析图表维度
 * @param {string} dimension - 维度类型 (org/category/businessType)
 */
switchROIDimension(dimension) {
  console.log('[Dashboard] 切换投产分析维度:', dimension);

  // 更新当前维度
  this.currentDimensions.roi = dimension;

  // 更新按钮状态
  const buttons = document.querySelectorAll('#roi-dimension-selector .dimension-btn');
  buttons.forEach(btn => {
    if (btn.dataset.dimension === dimension) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // 重新渲染图表
  this.renderROIChart('expense');
}

/**
 * 获取投产分析图表配置
 * @param {Array} data - 投产分析数据
 * @returns {Object} ECharts 配置对象
 */
getROIChartOption(data) {
  return {
    // ... (参考上面的完整配置示例)
  };
}

/**
 * 获取维度字段名
 * @param {string} dimension - 维度类型
 * @returns {string} 字段名
 */
getDimensionFieldName(dimension) {
  const mapping = {
    'org': 'third_level_organization',
    'category': 'customer_category_3',
    'businessType': 'ui_short_label'
  };
  return mapping[dimension] || 'third_level_organization';
}
```

### 3. Worker 数据处理

在 `js/data.worker.js` 中添加:

```javascript
// 监听投产分析数据请求
self.addEventListener('message', (e) => {
  if (e.data.type === 'get_roi_data') {
    console.log('[Worker] 收到投产分析数据请求:', e.data.payload);

    const { dimension, filters } = e.data.payload;

    // 应用筛选条件
    let filteredData = applyFilters(rawCSVData, filters);

    // 聚合投产分析数据
    const roiData = aggregateROIData(filteredData, dimension);

    // 返回结果
    self.postMessage({
      type: 'roi_data_complete',
      payload: roiData
    });
  }
});

/**
 * 聚合投产分析数据
 * @param {Array} data - 原始数据
 * @param {string} dimension - 聚合维度字段名
 * @returns {Array} 投产分析数据
 */
function aggregateROIData(data, dimension) {
  console.log('[Worker] 开始聚合投产分析数据, 维度:', dimension);

  const groups = {};

  // 步骤1: 数据分组
  data.forEach(row => {
    const dimValue = row[dimension];
    if (!dimValue) return;

    if (!groups[dimValue]) {
      groups[dimValue] = {
        签单保费: 0,
        费用额: 0,
        满期保费: 0,
        已报告赔款: 0
      };
    }

    groups[dimValue].签单保费 += parseFloat(row.签单保费 || 0);
    groups[dimValue].费用额 += parseFloat(row.费用额 || 0);
    groups[dimValue].满期保费 += parseFloat(row.满期保费 || 0);
    groups[dimValue].已报告赔款 += parseFloat(row.已报告赔款 || 0);
  });

  // 步骤2: 计算投产指标
  const roiData = Object.entries(groups).map(([name, data]) => {
    // 计算边际贡献额（车险业务标准公式）
    // 公式: 边际贡献额 = 签单保费 × (1 - 已报告赔款/满期保费 + 费用金额/签单保费)
    let 边际贡献额 = 0;
    if (data.签单保费 > 0 && data.满期保费 > 0) {
      const 满期赔付率 = data.已报告赔款 / data.满期保费;
      const 费用率 = data.费用额 / data.签单保费;
      边际贡献额 = data.签单保费 * (1 - 满期赔付率 + 费用率);
    }

    return {
      维度值: name,
      签单保费: data.签单保费,
      费用额: data.费用额,

      // 核心指标
      费用产出保费比: data.费用额 > 0
        ? parseFloat((data.签单保费 / data.费用额).toFixed(2))
        : 0,

      费用产出边际贡献: data.费用额 > 0
        ? parseFloat((边际贡献额 / data.费用额).toFixed(2))
        : 0,

      边际贡献率: data.签单保费 > 0
        ? parseFloat(((边际贡献额 / data.签单保费) * 100).toFixed(1))
        : 0
    };
  });

  // 步骤3: 过滤无效数据
  const validData = roiData.filter(item => {
    return item.费用额 > 0 && item.签单保费 > 0;
  });

  // 步骤4: 按费用额降序排序
  validData.sort((a, b) => b.费用额 - a.费用额);

  console.log('[Worker] 投产分析数据聚合完成, 数据量:', validData.length);

  return validData;
}
```

---

## 七、样式规范

### 1. CSS 样式

在 `css/dashboard.css` 中添加:

```css
/* 投产分析图表容器 */
.roi-chart-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: var(--card-shadow);
  margin-bottom: 24px;
}

/* 维度选择器样式 (复用现有样式) */
#roi-dimension-selector {
  display: flex;
  gap: 8px;
}

#roi-dimension-selector .dimension-btn {
  padding: 6px 16px;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 13px;
  color: #666;
}

#roi-dimension-selector .dimension-btn:hover {
  border-color: #0070c0;
  color: #0070c0;
}

#roi-dimension-selector .dimension-btn.active {
  background: #0070c0;
  color: #fff;
  border-color: #0070c0;
}

/* 指标说明样式 */
.chart-legend-info {
  margin-top: 10px;
  padding: 12px;
  background: #f9f9f9;
  border-radius: 4px;
  border-left: 3px solid #0070c0;
}

.chart-legend-info strong {
  color: #333;
  font-size: 13px;
}

.chart-legend-info div {
  font-size: 12px;
  color: #666;
  line-height: 1.8;
}
```

---

## 八、业务分析应用场景

### 场景1: 识别高效机构

**判断标准**:
- 费用产出保费比 ≥ 6元
- 费用产出边际贡献 ≥ 2元
- 边际贡献率 ≥ 20%

**管理决策**:
- **优质机构**: 增加资源投入,扩大规模
- **低效机构**: 分析原因,改进策略或调整资源

---

### 场景2: 优化客户结构

**分析步骤**:
1. 切换到"客户类别"维度
2. 对比不同客户类别的投产指标
3. 识别高价值客户群体

**管理决策**:
- 将营销资源倾斜到边际贡献率高的客户类别
- 减少低效客户类别的费用投入

---

### 场景3: 业务类型决策

**分析步骤**:
1. 切换到"业务类型"维度
2. 对比不同业务类型的投产效率
3. 识别核心业务和边缘业务

**管理决策**:
- 聚焦高产出业务类型
- 调整业务组合,优化资源配置

---

### 场景4: 综合评估矩阵

**四象限分析**:

```
边际贡献率
    ↑
 高 │  A象限: 黄金业务           B象限: 潜力业务
    │  (高产出 + 高利润)        (高利润 + 低产出)
    │  • 重点支持              • 提升产出效率
    │
────┼─────────────────────────────────────→ 费用产出比
    │
 低 │  C象限: 规模业务           D象限: 问题业务
    │  (高产出 + 低利润)        (低产出 + 低利润)
    │  • 控制成本              • 考虑退出
```

---

## 九、异常情况处理

### 1. 数据异常

**问题**: 费用额为0或为负
**处理**: 过滤掉该条数据,记录警告日志

**问题**: 签单保费为0
**处理**: 过滤掉该条数据,记录警告日志

**问题**: 费用产出边际贡献为负
**处理**: 保留数据,在图表中以红色标注,提示业务亏损

---

### 2. 渲染异常

```javascript
try {
  const chartData = this.prepareROIChartData();
  this.roiChart.setOption(chartData, true);
} catch (error) {
  console.error('[Dashboard] 投产分析图表渲染失败:', error);

  // 显示错误提示
  this.showEmptyState('chart-roi', '数据加载失败,请刷新页面重试');

  // 尝试重新初始化
  setTimeout(() => {
    this.initROIChart();
  }, 2000);
}
```

---

## 十、性能优化

### 1. 数据缓存

```javascript
// 缓存投产分析数据
this._roiDataCache = new Map();

getCachedROIData(dimension, filters) {
  const cacheKey = `${dimension}_${JSON.stringify(filters)}`;

  if (!this._roiDataCache.has(cacheKey)) {
    const data = this.processROIData(dimension, filters);
    this._roiDataCache.set(cacheKey, data);
  }

  return this._roiDataCache.get(cacheKey);
}
```

### 2. 防抖渲染

```javascript
this.debouncedRenderROIChart = this.debounce(() => {
  this._renderROIChartInternal();
}, 100);
```

---

## 十一、测试要点

### 1. 数据准确性测试
- ✓ 验证费用产出保费比计算公式
- ✓ 验证费用产出边际贡献计算公式
- ✓ 验证边际贡献率计算公式
- ✓ 验证聚合汇总逻辑

### 2. 维度切换测试
- ✓ 验证三个维度的切换响应性
- ✓ 验证按钮状态更新
- ✓ 验证图表数据正确性

### 3. 交互功能测试
- ✓ 验证提示框信息完整性
- ✓ 验证数据标签显示正确性
- ✓ 验证预警线显示正确性

### 4. 边界情况测试
- ✓ 测试空数据情况
- ✓ 测试极端值处理
- ✓ 测试负值边际贡献的显示

---

## 十二、实施计划

| 步骤 | 任务 | 预计工作量 | 依赖 |
|-----|------|-----------|------|
| 1 | 更新板块文档 | 0.5h | 无 |
| 2 | 修改 HTML 结构 | 0.5h | 步骤1 |
| 3 | 实现 Worker 数据处理 | 1h | 步骤2 |
| 4 | 实现图表渲染逻辑 | 1.5h | 步骤3 |
| 5 | 集成维度切换 | 0.5h | 步骤4 |
| 6 | 样式调整 | 0.5h | 步骤4 |
| 7 | 测试验证 | 1h | 步骤6 |

**总计**: 约5-6小时

---

## 十三、扩展性设计

### 1. 预警线扩展

```javascript
// 支持自定义预警线
const roiWarningLines = {
  feeToRevenue: {
    value: 5,
    color: '#ffc000',
    label: '产出基准线'
  },
  marginRate: {
    value: 20,
    color: '#00b050',
    label: '利润目标线'
  }
};
```

### 2. 指标扩展

```javascript
// 支持添加新指标
const additionalMetrics = {
  // 费用效率指数 = (边际贡献额 / 费用额) / (签单保费 / 费用额) * 100
  costEfficiencyIndex: (marginContribution, revenue, fee) => {
    const marginRatio = fee > 0 ? marginContribution / fee : 0;
    const revenueRatio = fee > 0 ? revenue / fee : 0;
    return revenueRatio > 0 ? (marginRatio / revenueRatio) * 100 : 0;
  }
};
```

---

## 十四、风险评估

| 风险项 | 风险等级 | 缓解措施 |
|-------|---------|---------|
| 数据计算错误 | 中 | 编写单元测试,验证公式正确性 |
| 性能影响 | 低 | 使用 Worker 处理,添加缓存机制 |
| 兼容性问题 | 低 | 复用成熟架构,无新技术引入 |
| 用户理解困难 | 中 | 添加指标说明,提供操作指引 |

---

## 十五、文档维护

**最后更新**: 2025-12-22
**版本号**: 2.0
**维护者**: autowrKPI Team
**关联文档**:
- `开发文档/板块文档/06_费用支出板块.md`
- `开发文档/KNOWLEDGE_INDEX.md`
- `CLAUDE.md`

---

**附录: 关键代码文件清单**

| 文件路径 | 修改内容 | 关键行数 |
|---------|---------|---------|
| `index.html` | 新增投产分析图容器 | ~340-365 |
| `js/dashboard.js` | 渲染逻辑 + 维度切换 | ~2300-2500 |
| `js/data.worker.js` | 投产指标计算 | ~600-700 |
| `css/dashboard.css` | 图表容器样式 | ~1600-1650 |
