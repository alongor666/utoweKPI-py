# 损失暴露板块详细文档

## 模块概述
损失暴露板块是系统中最为复杂的分析模块，提供双模式分析视图：赔付率VS占比的组合图分析，以及频度VS额度的象限分析。支持三级机构/客户类别/业务类型三个维度的切换，并包含摩托车模式等高级业务逻辑。

## 核心功能

### 1. 双模式分析系统

#### 赔付率VS占比模式 (bubble)
- **图表类型**: 双Y轴组合图（柱状图 + 折线图）
- **左Y轴**: 占比(%)，范围0-100
- **右Y轴**: 满期赔付率(%)，范围0-130
- **数据系列**: 保费占比、赔款贡献度、满期赔付率
- **核心指标**:
  - 保费贡献度(%) = 维度签单保费 / 总签单保费 × 100%
  - 赔款贡献度(%) = 维度已报告赔款 / 总已报告赔款 × 100%
  - 满期赔付率(%) = 已报告赔款 / 满期保费 × 100%

#### 频度VS额度模式 (quadrant)
- **图表类型**: 散点图
- **X轴**: 出险率(%)，表示出险频度
- **Y轴**: 案均赔款(元)，表示损失额度
- **气泡大小**: 基于签单保费
- **动态预警线**: 根据摩托车模式调整
- **核心指标**:
  - 出险率(%) = 赔案件数 / 保单件数 × 100%
  - 案均赔款(元) = 已报告赔款 / 赔案件数
  - 签单保费(元) = 维度签单保费汇总（用于气泡大小）

### 2. 子标签切换机制
```html
<div class="sub-tabs">
    <button class="sub-tab active" data-subtab="bubble">赔付率VS占比</button>
    <button class="sub-tab" data-subtab="quadrant">频度VS额度</button>
</div>
```

### 3. 摩托车模式预警系统
- **识别逻辑**: 基于业务类型筛选条件自动判断
- **预警线调整**: 根据是否包含摩托车动态调整阈值
- **三种模式**: 仅摩托车、不含摩托车、全部业务

## 数据处理逻辑

### 1. 维度字段映射
```javascript
const dimensionMapping = {
    'org': 'third_level_organization',
    'category': 'ui_customer_category',
    'businessType': 'ui_short_label'
};
```

### 2. 赔付率VS占比数据结构
```javascript
chartData = {
    series: [
        {
            name: '保费贡献度',        // 原保费占比
            type: 'bar',
            yAxisIndex: 0,
            data: [28.5, 22.1, 18.7, ...]
        },
        {
            name: '赔款贡献度',        // 原已报告赔款占比  
            type: 'bar',
            yAxisIndex: 0,
            data: [32.1, 19.8, 16.4, ...]
        },
        {
            name: '满期赔付率',
            type: 'line',
            yAxisIndex: 1,
            data: [65.2, 72.8, 58.9, ...],
            lineStyle: { color: '#c00000', width: 3 }
        }
    ]
};
```

### 3. 频度VS额度数据结构
```javascript
chartData = {
    series: [{
        type: 'scatter',
        data: [
            {
                name: '天府新区',
                value: [15.2, 4800, 2856000],  // [出险率, 案均赔款, 签单保费]
                itemStyle: { color: '#00b050' }
            }
        ],
        symbolSize: (val, params) => this.calculateBubbleSize(premiums, params.dataIndex)
    }],
    // 动态预警线
    markLine: {
        data: this.getMotorcycleModeWarningLines()
    }
};
```

## 交互设计

### 1. 子标签切换逻辑
```javascript
switchSubTab(tab, subTab, element) {
    // 更新UI状态
    document.querySelectorAll(`[data-tab="${tab}"] .sub-tab`).forEach(btn => {
        btn.classList.remove('active');
    });
    element.classList.add('active');
    
    // 更新内部状态
    this.currentSubTab[tab] = subTab;
    
    // 重新渲染图表
    this.renderChart(tab);
}
```

### 2. 摩托车模式判断逻辑
```javascript
getMotorcycleModeWarningLines() {
    const businessTypes = this.filterState.drill.applied
        .find(c => c.dimension === 'ui_short_label')?.values || [];
    
    const isMotorcycleOnly = businessTypes.length === 1 && businessTypes[0] === '摩托车';
    const excludeMotorcycle = businessTypes.length > 0 && !businessTypes.includes('摩托车');
    
    let mode = '全部业务';
    if (isMotorcycleOnly) mode = '仅摩托车';
    else if (excludeMotorcycle) mode = '不含摩托车';
    
    const configs = {
        '不含摩托车': [
            { xAxis: 15, name: '出险频度预警线' },
            { yAxis: 4500, name: '案均赔款预警线' }
        ],
        '含摩托车': [
            { xAxis: 12, name: '出险频度预警线' },
            { yAxis: 4900, name: '案均赔款预警线' }
        ]
    };
    
    return configs[mode] || configs['含摩托车'];
}
```

### 3. 特殊颜色规则实现
```javascript
getSpecialBarColor(seriesName, value, dimensionData) {
    if (seriesName === '赔款贡献度') {
        const claimContribution = value;
        const premiumContribution = dimensionData.保费占比;
        
        // 赔款贡献度 > 保费贡献度时显示红色
        if (claimContribution > premiumContribution) {
            return '#c00000';  // 危险红色
        }
    }
    return this.getDefaultSeriesColor(seriesName);
}
```

## 样式规范

### 1. 子标签样式
```css
.sub-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0;
}

.sub-tab {
    background: none;
    border: none;
    padding: 12px 20px;
    border-bottom: 3px solid transparent;
    color: #666666;
    font-weight: 500;
    transition: var(--transition);
    cursor: pointer;
}

.sub-tab.active {
    color: var(--primary-red);
    border-bottom-color: var(--primary-red);
    font-weight: 600;
}

.sub-tab:hover {
    color: var(--primary-red);
    background: rgba(160, 39, 36, 0.05);
}
```

### 2. 组合图样式
```javascript
// 柱状图配置
{
    type: 'bar',
    yAxisIndex: 0,
    itemStyle: {
        borderColor: 'rgba(255, 255, 255, 0.8)',
        borderWidth: 1
    },
    label: {
        show: true,
        position: 'inside',
        formatter: '{c}%',
        color: 'white',
        fontWeight: '600'
    }
}

// 折线图配置  
{
    type: 'line',
    yAxisIndex: 1,
    lineStyle: {
        color: '#808080',  // 灰色连线
        width: 3,
        type: 'solid'
    },
    symbol: 'circle',
    symbolSize: 6,
    itemStyle: { color: '#c00000' }
}
```

### 3. 散点图样式
```javascript
{
    type: 'scatter',
    symbolSize: (val, params) => this.calculateBubbleSize(premiums, params.dataIndex),
    itemStyle: {
        borderColor: 'rgba(255, 255, 255, 0.8)',
        borderWidth: 1,
        opacity: 0.8
    },
    label: {
        show: true,
        position: 'top',
        formatter: (p) => {
            const name = this.wrapTextByCharCount(p.data.name, 6);
            const rate = this.formatRate(p.data.value[0], 1);  // 出险率
            const amount = this.formatInteger(p.data.value[1]); // 案均赔款
            return `${name}\n${rate}%\n${amount}元`;
        }
    }
}
```

## 业务规则

### 1. 指标名称映射（待更新）
| 原名称 | 新名称 | 英文映射 |
|-------|-------|---------|
| 已报告赔款占比 | 赔款贡献度 | claimContribution |
| 保费占比 | 保费贡献度 | premiumContribution |
| 赔付率VS占比 | 满期赔付率VS赔款贡献度 | lossRateVsContribution |

### 2. 摩托车模式规则
- **仅摩托车**: 出险频度预警线15%，案均赔款预警线4500元
- **不含摩托车**: 出险频度预警线12%，案均赔款预警线4900元
- **全部业务**: 使用包含摩托车的标准

### 3. 特殊颜色规则
- **赔款贡献度**: 默认灰色，但当大于保费贡献度时显示红色
- **保费贡献度**: 始终灰色显示
- **满期赔付率连线**: 使用灰色而非红色

## 性能优化

### 1. 模式切换优化
```javascript
// 缓存不同模式的数据
this._modeCache = {
    bubble: null,
    quadrant: null
};

switchSubTab(tab, subTab, element) {
    if (!this._modeCache[subTab]) {
        this._modeCache[subTab] = this.processDataForMode(subTab);
    }
    
    this.renderChartWithData(this._modeCache[subTab]);
}
```

### 2. 动态预警线计算优化
```javascript
// 缓存摩托车模式判断结果
this._motorcycleModeCache = new Map();

getMotorcycleModeWarningLines() {
    const cacheKey = this.filterState.drill.applied
        .filter(c => c.dimension === 'ui_short_label')
        .map(c => c.values.sort().join(','))
        .join(';');
    
    if (!this._motorcycleModeCache.has(cacheKey)) {
        const lines = this.calculateWarningLines(cacheKey);
        this._motorcycleModeCache.set(cacheKey, lines);
    }
    
    return this._motorcycleModeCache.get(cacheKey);
}
```

### 3. 图表渲染优化
- 使用requestAnimationFrame优化动画
- 大数据量时启用采样显示
- 延迟非关键渲染

## 扩展性设计

### 1. 分析模式扩展
```javascript
// 支持新增分析模式
const analysisModes = {
    'bubble': this.renderBubbleChart,
    'quadrant': this.renderQuadrantChart,
    'trend': this.renderTrendChart,      // 新增趋势分析
    'comparison': this.renderComparisonChart // 新增对比分析
};
```

### 2. 预警线配置扩展
```javascript
const warningLineConfigs = {
    motorcycle: {
        frequency: 15,
        amount: 4500
    },
    nonMotorcycle: {
        frequency: 12, 
        amount: 4900
    },
    custom: {
        // 支持自定义配置
    }
};
```

### 3. 颜色规则扩展
```javascript
const colorRules = {
    claimContribution: {
        default: '#92d050',
        condition: (value, context) => value > context.premiumContribution,
        special: '#c00000'
    },
    premiumContribution: {
        default: '#0070c0'
        // 固定颜色，无特殊规则
    }
};
```

## 配置管理

### 1. 业务类型配置
```javascript
const businessTypeConfig = {
    motorcycle: '摩托车',
    impactWarningLines: true,
    specialHandling: true
};
```

### 2. 图表配置
```javascript
const chartConfigs = {
    bubble: {
        height: 500,
        animationDuration: 800,
        tooltipDelay: 50
    },
    quadrant: {
        height: 500,
        bubbleSizeRange: [20, 80],
        enableZoom: true
    }
};
```

## 错误处理

### 1. 模式切换异常
- 模式配置缺失时回退到默认模式
- 数据处理失败时显示错误提示
- 渲染失败时尝试重新初始化

### 2. 预警线计算异常
- 业务类型筛选异常时使用默认值
- 数值越界时自动限制在合理范围
- 配置冲突时优先使用业务规则

## 测试要点

### 1. 模式切换测试
- 验证子标签切换响应性
- 验证数据在不同模式下的一致性
- 验证UI状态同步正确性

### 2. 摩托车模式测试
- 验证不同业务类型组合下的预警线
- 验证模式判断逻辑正确性
- 验证预警线显示准确性

### 3. 特殊颜色规则测试
- 验证赔款贡献度颜色变化逻辑
- 验证灰色连线的显示效果
- 验证颜色在不同数据下的正确性