# 变动成本板块详细文档

## 模块概述
变动成本板块通过散点图的形式，直观展示各维度在满期赔付率和费用率两个成本维度上的分布情况，帮助识别成本控制的重点区域和异常点，支持三级机构/客户类别/业务类型三个维度的切换分析。

## 核心功能

### 1. 双轴散点图系统
- **X轴**: 满期赔付率(%)，范围0-130
- **Y轴**: 费用率(%)，范围0-30
- **气泡大小**: 代表保费规模（保费占比）
- **气泡颜色**: 基于变动成本率的状态着色
- **核心指标**:
  - 满期赔付率(%) = 已报告赔款 / 满期保费 × 100%
  - 费用率(%) = 费用金额 / 签单保费 × 100%
  - 变动成本率(%) = 满期赔付率 + 费用率
  - 保费占比(%) = 维度签单保费 / 总签单保费 × 100%

### 2. 双预警线机制
- **垂直预警线**: 满期赔付率预警线（默认75%）
- **水平预警线**: 费用率预警线（默认17%）
- **交点分析**: 四象限分析框架

### 3. 数据标注系统
- **主标注**: 维度名称（自动换行）
- **副标注**: 变动成本率百分比
- **定位策略**: 气泡顶部智能定位，避免重叠

## 数据处理逻辑

### 1. 维度字段映射
```javascript
const dimensionMapping = {
    'org': 'third_level_organization',
    'category': 'ui_customer_category', 
    'businessType': 'ui_short_label'
};
```

### 2. 数据聚合流程
1. **分组**: 按`dimensionField`对原始数据进行分组
2. **基础指标计算**: 签单保费、已报告赔款、费用金额汇总
3. **相对指标计算**: 
   - 满期赔付率 = 已报告赔款 / 满期保费 × 100%
   - 费用率 = 费用金额 / 签单保费 × 100%
   - 变动成本率 = 满期赔付率 + 费用率
   - 保费占比 = 维度保费 / 总保费 × 100%
4. **坐标映射**: 转换为散点图的(X,Y)坐标

### 3. 图表数据结构
```javascript
chartData = {
    series: [{
        type: 'scatter',
        data: [
            {
                name: '天府新区',
                value: [65.2, 12.3, 77.5, 28.5],  // [满期赔付率, 费用率, 变动成本率, 保费占比]
                itemStyle: { color: '#00b050' }
            },
            {
                name: '新都区域', 
                value: [78.9, 15.6, 94.5, 22.1],
                itemStyle: { color: '#c00000' }
            }
        ],
        symbolSize: (val, params) => this.calculateBubbleSize(premiumShares, params.dataIndex)
    }]
};
```

## 交互设计

### 1. 维度切换机制
```javascript
switchDimension('cost', dimension) {
    this.currentDimensions.cost = dimension;
    this.renderChart('cost');
}
```

### 2. 智能气泡大小计算
```javascript
calculateBubbleSize(premiumShares, index) {
    const share = premiumShares[index];
    const minSize = 20;
    const maxSize = 80;
    // 基于保费占比的平方根缩放，保持视觉平衡
    return minSize + (share / 100) * (maxSize - minSize);
}
```

### 3. 数据提示框
- **基础信息**: 维度名称
- **坐标信息**: 满期赔付率、费用率具体数值
- **汇总信息**: 变动成本率、保费占比
- **格式化**: 百分比保留1位小数

### 4. 标签智能换行
```javascript
wrapTextByCharCount(text, maxChars) {
    if (text.length <= maxChars) return text;
    const breakPoint = text.lastIndexOf('-', maxChars);
    return breakPoint > 0 ? 
        text.substring(0, breakPoint + 1) + '\n' + text.substring(breakPoint + 1) :
        text.substring(0, maxChars) + '\n' + text.substring(maxChars);
}
```

## 样式规范

### 1. 散点图配置
```css
#chart-cost {
    height: 500px;
    width: 100%;
}

.scatter-point {
    transition: all 0.3s ease;
    cursor: pointer;
}

.scatter-point:hover {
    stroke-width: 2;
    stroke: rgba(0, 0, 0, 0.3);
}
```

### 2. 预警线样式
```javascript
markLine: {
    silent: false,
    symbol: ['none', 'none'],  // 不显示端点符号
    lineStyle: {
        color: '#ffc000',
        type: 'dashed',
        width: 2
    },
    label: {
        show: true,
        position: 'end',
        formatter: '{b}: {c}%'
    }
}
```

### 3. 数据标签样式
```javascript
label: {
    show: true,
    position: 'top',
    distance: 5,
    formatter: (p) => {
        const name = this.wrapTextByCharCount(p.data.name, 6);
        const rate = this.formatRate(p.data.value[2], 1);
        return `${name}\n${rate}%`;
    },
    color: '#333333',
    fontSize: 12,
    fontWeight: '600',
    textBorderColor: 'rgba(255, 255, 255, 0.8)',
    textBorderWidth: 2
}
```

## 业务规则

### 1. 四象限分析框架
- **左下象限**: 低满期赔付率 + 低费用率（优秀区域）
- **右下象限**: 高满期赔付率 + 低费用率（关注赔付）
- **左上象限**: 低满期赔付率 + 高费用率（关注费用）
- **右上象限**: 高满期赔付率 + 高费用率（重点改进）

### 2. 状态判断规则
```javascript
getStatusColor(costRate) {
    if (costRate > 94) return '#c00000';      // 危险 - 右上象限倾向
    else if (costRate > 91) return '#ffc000'; // 预警 - 接近右上
    else return '#00b050';                     // 正常 - 偏向左下
}
```

### 3. 预警阈值配置
```javascript
const thresholds = {
    claimRateWarning: 75,    // 满期赔付率预警线
    expenseRateWarning: 17   // 费用率预警线
};
```

## 性能优化

### 1. 气泡大小缓存
```javascript
// 缓存计算结果，避免重复计算
this._bubbleSizeCache = this._bubbleSizeCache || {};
const cacheKey = premiumShares.join('-');
if (!this._bubbleSizeCache[cacheKey]) {
    this._bubbleSizeCache[cacheKey] = premiumShares.map(share => 
        this.calculateBubbleSize([share], 0)
    );
}
```

### 2. 标签重叠处理
- 自动检测标签重叠
- 智能调整标签位置
- 过度密集时隐藏部分标签

### 3. 渲染优化
- 使用Canvas渲染提高性能
- 大数据量时启用采样显示
- 动画效果按需开启

## 交互增强

### 1. 气泡点击钻取
```javascript
series: [{
    // ...其他配置
    onclick: (params) => {
        const dimension = params.data.name;
        this.drillDownToDetail(dimension);
    }
}]
```

### 2. 缩放和平移
```javascript
dataZoom: [
    {
        type: 'inside',
        xAxisIndex: 0,
        filterMode: 'none'
    },
    {
        type: 'inside', 
        yAxisIndex: 0,
        filterMode: 'none'
    }
]
```

### 3. 象限高亮
- 鼠标悬停时高亮同象限数据点
- 显示象限统计信息
- 支持象限数据筛选

## 扩展性设计

### 1. 多指标支持
- 支持添加第三个维度（如渠道效率）
- 支持自定义坐标轴指标
- 支持指标权重配置

### 2. 动态预警线
- 基于历史数据的动态阈值
- 支持多级预警线配置
- 支持预警线个性化设置

### 3. 分析模式扩展
- 支持时间序列对比
- 支持目标值对比
- 支持行业基准对比

## 配置管理

### 1. 预警线配置
```javascript
const warningLines = {
    claimRate: {
        warning: 75,
        danger: 85,
        color: '#ffc000',
        type: 'dashed'
    },
    expenseRate: {
        warning: 17,
        danger: 22,
        color: '#ffc000', 
        type: 'dashed'
    }
};
```

### 2. 气泡样式配置
```javascript
const bubbleStyle = {
    minSize: 20,
    maxSize: 80,
    opacity: 0.8,
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.8)'
};
```

## 错误处理

### 1. 数据异常处理
- **除零错误**: 比率计算时的分母为零保护
- **负值处理**: 异常负值的过滤和警告
- **极值处理**: 超出范围的数值限制

### 2. 渲染异常处理
- **无数据**: 显示友好的空状态提示
- **单点数据**: 特殊处理避免渲染异常
- **标签重叠**: 自动调整标签位置

## 测试要点

### 1. 数据准确性测试
- 验证比率计算公式正确性
- 验证坐标映射准确性
- 验证气泡大小比例关系

### 2. 交互功能测试
- 验证维度切换响应性
- 验证提示框信息完整性
- 验证预警线显示正确性

### 3. 视觉效果测试
- 验证标签可读性
- 验证颜色区分度
- 验证气泡重叠处理效果