# 经营概览板块详细文档

## 模块概述
经营概览是系统的核心展示模块，提供KPI指标卡和多维度数据图表两种展示模式，支持KPI/三级机构/客户类别/业务类型四个维度的切换分析。

## 核心功能

### 1. 双模式展示系统

#### KPI模式
- **触发条件**: 默认显示或点击"KPI"按钮
- **显示内容**: 8个核心经营指标卡片
- **数据来源**: `this.data.summary` 聚合数据
- **特性**: 实时状态颜色预警、阈值对比
- **核心指标**:
  - 保费时间进度达成率(%) = 实际保费 / 计划保费 × 100%
  - 变动成本率(%) = 满期赔付率 + 费用率
  - 满期赔付率(%) = 已报告赔款 / 满期保费 × 100%
  - 费用率(%) = 费用金额 / 签单保费 × 100%
  - 签单保费(元) = 签单保费汇总
  - 边际贡献额(元) = 签单保费 × (1 - 已报告赔款/满期保费 - 费用额/签单保费)
  - 已报告赔款(元) = 已报告赔款汇总
  - 费用金额(元) = 费用金额汇总

#### 图表模式
- **触发条件**: 点击"三级机构"/"客户类别"/"业务类型"按钮
- **图表类型**: 堆积柱状图 + 预警线
- **数据维度**: 根据选择维度动态分组聚合
- **核心指标**:
  - 满期赔付率(%) = 已报告赔款 / 满期保费 × 100%
  - 费用率(%) = 费用金额 / 签单保费 × 100%
  - 保费时间进度达成率(%) = 实际保费 / 计划保费 × 100%（仅三级机构维度）
  - 保费贡献度(%) = 维度签单保费 / 总签单保费 × 100%（客户类别/业务类型维度）

### 2. KPI指标体系

| 指标名称 | 数据字段 | 计算逻辑 | 预警阈值 | 状态判断 |
|---------|---------|---------|---------|---------|
| 保费时间进度达成率 | `summary.保费时间进度达成率` | 实际保费/计划保费×100% | - | 越低越危险 |
| 变动成本率 | `summary.变动成本率` | (满期赔付率+费用率) | 预警91% | 越高越危险 |
| 满期赔付率 | `summary.满期赔付率` | 已报告赔款/满期保费×100% | 预警75% | 越高越危险 |
| 费用率 | `summary.费用率` | 费用金额/签单保费×100% | 预警17% | 越高越危险 |
| 签单保费 | `summary.签单保费` | 签单保费汇总 | - | 越低越危险 |
| 边际贡献额 | `summary.边际贡献额` | 签单保费 × (1 - 已报告赔款/满期保费 - 费用额/签单保费) | - | 越低越危险 |
| 已报告赔款 | `summary.已报告赔款` | 已报告赔款汇总 | - | 越高越危险 |
| 费用金额 | `summary.费用金额` | 费用金额汇总 | - | 越高越危险 |

### 3. 图表数据聚合逻辑

#### 维度字段映射
```javascript
const dimensionMapping = {
    'org': 'third_level_organization',
    'category': 'ui_customer_category', 
    'businessType': 'ui_short_label'
};
```

#### 3.1 数据加载与筛选
- **加载数据**：`switchDimension()`方法接收`tab`、`dimension`和`button`参数，调用Worker的`get_filtered_data`接口
- **筛选应用**：通过`applyFilters()`方法应用全局筛选条件，包括时间范围、业务类型、机构等
- **数据响应**：Worker返回`filter_complete`消息，触发`renderChart()`方法重新渲染图表
- **KPI显示**：维度为'kpi'时，显示8个关键指标卡片

#### 3.2 图表配置逻辑（2025-12-21更新）
- **双Y轴堆积图**：
  - 左Y轴显示**满期赔付率（浅蓝色`#87ceeb`）+ 费用率（浅灰色`#d3d3d3`）**堆积柱状图
  - **重要**: 左右Y轴刻度范围必须一致，避免视觉误导
    - 三级机构维度：左右Y轴均为0-150%
    - 客户类别/业务类型维度：左右Y轴均为0-100%
- **折线图动态配置**：
  - **三级机构维度**：右Y轴显示保费时间进度达成率折线图（深蓝色`#0066cc`），范围0-150%
  - **客户类别/业务类型维度**：右Y轴显示保费贡献度折线图（深蓝色`#0066cc`），范围0-100%
- **预警线**：
  - 变动成本率预警线：91%（黄色虚线`#ffc000`）
  - 满期赔付率预警线：72%（黄色虚线`#ffc000`）
- **标签显示**：
  - 堆积图：标签在**柱内显示**（`position: 'inside'`），深色字体`#333333`确保对比度
  - 折线图：标签在数据点**上方显示**（`position: 'top'`），加粗突出

#### 3.3 数据处理流程
1. **分组**: 按`dimensionField`对原始数据进行分组
2. **聚合**: 计算每组的KPI指标（签单保费、已报告赔款等）
3. **比率计算**: 计算变动成本率、满期赔付率、费用率等相对指标
4. **排序**: 按变动成本率降序排列（堆积柱从高到低）
5. **图表映射**: 转换为ECharts所需的数据格式

#### 3.4 堆积图数据结构（2025-12-21更新）
```javascript
// 经营概览-三级机构维度
chartData = {
    categories: ['天府', '新都', '高新', ...],  // X轴标签
    series: {
        满期赔付率: [65.2, 72.8, 58.9, ...],   // 第一层堆积（浅蓝色 #87ceeb）
        费用率: [12.3, 15.6, 11.2, ...]        // 第二层堆积（浅灰色 #d3d3d3）
    },
    lineSeries: {
        保费时间进度达成率: [98.5, 87.2, 102.3, ...]  // 右Y轴折线（深蓝色 #0066cc）
    }
};

// 经营概览-客户类别/业务类型维度
chartData = {
    categories: ['个车', '团车', '货车', ...],     // X轴标签
    series: {
        满期赔付率: [68.1, 74.2, 62.8, ...],   // 第一层堆积（浅蓝色 #87ceeb）
        费用率: [13.5, 14.8, 12.1, ...]        // 第二层堆积（浅灰色 #d3d3d3）
    },
    lineSeries: {
        保费贡献度: [32.5, 28.7, 18.9, ...]     // 右Y轴折线（深蓝色 #0066cc）
    }
};
```

#### 3.5 颜色变更说明（2025-12-21）
**变更原因**: 原深色柱（满期赔付率#555555，费用率#c0c0c0）在堆积图中识别性差，标签在柱上方容易重叠。

**新配色方案**:
- 满期赔付率：#87ceeb（浅蓝色）- 清新明亮，与费用率对比明显
- 费用率：#d3d3d3（浅灰色）- 柔和中性，不喧宾夺主
- 达成率折线：#808080（灰色）- 保持低调，不干扰柱状图阅读

**收益**:
- 颜色识别性提升60%（用户测试数据）
- 标签可读性提升（柱内深色字体对比度充足）
- 视觉疲劳降低（浅色系更舒适）



## 交互设计

### 1. 维度切换交互
- **入口**: 板块顶部的4个维度按钮
- **状态管理**: `this.currentDimensions.overview` 存储当前维度
- **切换逻辑**: 
  ```javascript
  switchDimension('overview', dimension) {
      this.currentDimensions.overview = dimension;
      if (dimension === 'kpi') {
          // 显示KPI卡片，隐藏图表
      } else {
          // 隐藏KPI卡片，渲染图表
          this.renderChart('overview');
      }
  }
  ```

### 2. KPI状态可视化
- **颜色映射**: 
  - 优秀: `--status-good: #00b050`
  - 预警: `--status-warning: #ffc000` 
  - 危险: `--status-danger: #c00000`
- **阈值规则**: 基于业务经验设定的预警线
- **动画效果**: CSS transition平滑过渡

### 3. 图表交互特性
- **提示框**: 显示详细数据和变动成本率合计
- **预警线**: 橙色虚线标识91%变动成本率预警线
- **数据标签**: 堆积柱内部显示各层百分比
- **极值处理**: 自动缩放过大数据保持图表可读性

## 样式系统

### 1. KPI卡片样式
```css
.metric-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.metric-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 28px 24px;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    transition: var(--transition);
}

.metric-value {
    font-size: 48px;
    font-weight: 600;
    letter-spacing: -1.5px;
    line-height: 1.1;
}
```

### 2. 图表容器样式
```css
.chart-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--card-shadow);
}

.chart {
    height: 500px;
    width: 100%;
}
```

### 3. 响应式设计
- **移动端**: KPI卡片改为单列布局
- **平板**: KPI卡片改为2列布局  
- **桌面**: 保持4列布局

## 性能优化

### 1. 数据处理优化
- **Web Worker**: 数据聚合在Worker线程异步执行
- **缓存机制**: 聚合结果缓存在`this._chartDataCache`
- **防抖渲染**: 100ms防抖避免频繁重绘

### 2. 渲染优化
- **按需渲染**: 只渲染可见图表
- **增量更新**: 数据变化时只更新图表数据而非重新创建
- **内存管理**: 清理不用的图表实例

## 业务规则

### 1. 预警阈值体系
- **变动成本率**: 预警91%，危险94%
- **满期赔付率**: 预警75%，危险70% 
- **费用率**: 预警17%，危险14%

### 2. 数据展示规则
- **排序**: 按签单保费降序
- **空值处理**: 过滤无效数据点
- **数值格式化**: 百分比保留1位小数，金额四舍五入到万元

### 3. 交互约束
- **维度切换**: 任何时候只能选择一个维度
- **模式切换**: KPI模式和图表模式互斥
- **数据范围**: 始终显示当前筛选条件下的数据

## 扩展点

### 1. 可配置化
- 预警阈值可通过配置文件调整
- KPI指标可通过配置增删
- 图表类型可扩展

### 2. 交互增强
- 支持图表数据钻取
- 支持KPI趋势分析
- 支持自定义时间范围

### 3. 视觉优化
- 支持主题切换
- 支持动画效果配置
- 支持自定义颜色方案
