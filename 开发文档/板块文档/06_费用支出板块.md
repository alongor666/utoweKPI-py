# 费用支出板块详细文档

## 模块概述
费用支出板块专注于分析各维度的费用支出情况，包含三个核心图表：
1. **费用金额VS费用率图表**：通过双Y轴复合图表展示费用金额与费用率的综合分析
2. **费用超支分析图表**（2025-12-22优化）：展示费用超支额和费用率超支情况，直观反映与预算目标的偏差
3. **投产效率分析组合图**（2025-12-22新增）：展示费用投入的产出效率与盈利质量

支持三级机构/客户类别/业务类型三个维度的切换分析，帮助快速识别费用管理重点区域和费用控制效果。

**UI调整记录（2025-12-22）**：
- 费用结余分析 → 费用超支分析（更符合计算逻辑和图形呈现）
- 费用结余额 → 费用超支额（统一命名规范）
- 图表位置交换：费用超支分析图表置于费用金额VS费用率图表之前
- 费用超支额配色：浅灰色柱子（#d0d0d0），数值标签在柱子上方
- 数值标签颜色：正值红色（#ff0000）加粗、负值绿色（#00b050）加粗
- 全局线条优化：所有折线宽度从2px减至1px，提升视觉精细度
- 网格线移除：所有图表移除网格线，界面更简洁
- 单位显示优化：Y轴已有单位时，tooltip数值标签不再重复显示单位
- 新增投产效率分析组合图：置于费用超支分析图之后，沿用板块配色与线条规范

## 核心功能

### 1. 费用金额VS费用率图表（2025-12-21优化）
- **图表类型**: 双Y轴复合图表
  - 左Y轴：费用金额柱状图（灰色`#808080`，黑色字体）
  - 右Y轴：费用率折线图（深蓝色`#0066cc`，深蓝色字体）
- **核心指标**: 
  - 费用金额 = 费用额汇总
  - 费用率(%) = 费用金额 / 签单保费 × 100%
- **预警线**: 费用率14%预警线（黄色虚线`#ffc000`）
- **数据标签**: 
  - 柱子顶部显示费用金额（万元），黑色字体
  - 折线数据点显示费用率百分比，深蓝色字体

### 2. 费用超支分析图表（2025-12-22优化）
- **图表类型**: 双Y轴复合图表
  - 左Y轴：费用超支额柱状图（浅灰色`#d0d0d0`）
  - 右Y轴：费用率超支折线图（深蓝色`#0070c0`）
- **核心指标**:
  - 费用超支额（万元）= 签单保费 × (实际费用率/100 - 费用率阈值/100)
    - 负值：费用节约（绿色文字标签）
    - 正值：费用超支（红色文字标签）
  - 费用率超支（百分点）= 实际费用率 - 费用率阈值
    - 负值：在阈值内
    - 正值：超出阈值
- **预警线系统**:
  - 0轴预算基准线（黑色实线）：费用超支的分界线
  - 0%费用率阈值线（黄色虚线）：14%阈值标准线
- **配色方案**:
  - 费用超支额柱：浅灰色`#d0d0d0`（统一柱子颜色）
  - 费用超支额标签：正值红色`#ff0000`加粗 / 负值绿色`#00b050`加粗
  - 费用率超支线：深蓝色`#0070c0`
  - 预算基准线：黑色`#333333`
  - 阈值线：黄色`#ffc000`
- **业务价值**:
  - 量化费用控制效果（金额和率双重视角）
  - 识别费用管理优秀区域（绿色）和问题区域（红色）
  - 支持预算执行情况监控

### 3. 投产效率分析组合图（2025-12-22新增）
- **图表类型**: 双Y轴组合图
  - 左Y轴：费用产出保费比、费用产出边际贡献柱状图
  - 右Y轴：边际贡献率折线图
- **核心指标**:
  - 费用产出保费比 = 签单保费 / 费用额
  - 费用产出边际贡献 = 边际贡献额 / 费用额
  - 边际贡献率(%) = 边际贡献额 / 签单保费 × 100%
  - 费用超支额（万元）= 签单保费 × (实际费用率/100 - 费用率阈值/100)
- **配色方案**:
  - 费用产出保费比柱：深蓝色`#0070c0`
  - 费用产出边际贡献柱：深绿色`#00b050`（负值需红色强调）
  - 边际贡献率折线：深红色`#c00000`
- **数据标签**:
  - 柱状图保留2位小数（元）
  - 折线图保留1位小数（%）
  - 费用产出边际贡献为负时，标签显示红色加粗

### 4. 三色预警机制
- **正常绿色**: 费用率 ≤ 14%
- **预警橙色**: 14% < 费用率 ≤ 17%
- **危险红色**: 费用率 > 17%

### 5. 预警线系统
- **预警线位置**: 14%（橙色虚线）
- **动态显示**: 根据数据范围自动调整
- **标签格式**: "预警线: 14%"

## 数据处理逻辑

### 1. 维度字段映射
```javascript
const dimensionMapping = {
    'org': 'third_level_organization',
    'category': 'ui_customer_category',
    'businessType': 'ui_short_label'
};
```

### 2. 数据聚合流程
1. **分组**: 按`dimensionField`对原始数据进行分组
2. **费用汇总**: 计算每组的费用金额总额
3. **保费汇总**: 计算每组的签单保费总额
4. **费用率计算**: 费用金额 / 签单保费 × 100%
5. **费用结余计算**（2025-12-22新增）:
   - 读取费用率阈值配置（`thresholds.费用率阈值.预算阈值`，默认14%）
   - 计算费用率超支 = 实际费用率 - 预算阈值
   - 计算费用超支额 = 签单保费 × (实际费用率/100 - 预算阈值/100)
6. **投产效率指标计算**（用于投产效率分析组合图）:
   - 边际贡献额 = 签单保费 × (1 - 已报告赔款/满期保费 - 费用额/签单保费)
   - 费用产出保费比 = 签单保费 / 费用额
   - 费用产出边际贡献 = 边际贡献额 / 费用额
   - 边际贡献率 = 边际贡献额 / 签单保费 × 100
   - 费用额或签单保费为0时不参与投产效率图
   - 满期保费为0时边际贡献相关指标按0处理
7. **排序**: 按费用金额降序排列
8. **极值处理**: 对极端费用率值进行归一化

### 3. 图表数据结构（2025-12-21优化）
```javascript
// 费用支出双Y轴图表数据结构（简化版）
chartData = {
    categories: ['天府', '新都', '高新', '武侯', ...],
    series: [
        {
            name: '费用金额',
            type: 'bar',
            yAxisIndex: 0,
            data: [1250, 980, 1560, ...],  // 费用金额（元）
            itemStyle: { color: '#808080' },     // 灰色
            label: {
                show: true,
                position: 'top',
                formatter: (p) => `${this.formatWanYuanFromYuan(p.value)}万`,
                color: '#000000'  // 黑色字体
            }
        },
        {
            name: '费用率',
            type: 'line',
            yAxisIndex: 1,
            data: [12.3, 15.6, 11.2, ...], // 费用率（%）
            lineStyle: { color: '#0066cc' },      // 深蓝色
            label: {
                show: true,
                position: 'top',
                formatter: (p) => `${this.formatRate(p.value, 1)}%`,
                color: '#0066cc'  // 深蓝色字体
            },
            markLine: {
                // 费用率预警线配置
                data: [{
                    yAxis: 14,
                    name: '费用率预警线',
                    lineStyle: {
                        color: '#ffc000',
                        type: 'dashed',
                        width: 2
                    },
                    label: {
                        formatter: '费用率预警线: {c}%',
                        color: '#ffc000'
                    }
                }]
            }
        }
    ]
};

// 费用结余双Y轴图表数据结构（2025-12-22新增）
surplusChartData = {
    categories: ['天府', '新都', '高新', '武侯', ...],
    series: [
        {
            name: '费用超支额',
            type: 'bar',
            yAxisIndex: 0,
            data: [
                { value: -18.2, itemStyle: { color: '#00b050' } },  // 节约：绿色
                { value: 5.3, itemStyle: { color: '#c00000' } },    // 超支：红色
                ...
            ],
            label: {
                show: true,
                position: (p) => p.value >= 0 ? 'top' : 'bottom',
                formatter: (p) => `${p.value >= 0 ? '+' : ''}${formatWanYuan(p.value)}万`,
                color: (p) => p.value >= 0 ? '#c00000' : '#00b050'
            },
            markLine: {
                data: [{
                    yAxis: 0,
                    name: '预算基准线',
                    lineStyle: { color: '#333333', type: 'solid', width: 2 }
                }]
            }
        },
        {
            name: '费用率超支',
            type: 'line',
            yAxisIndex: 1,
            data: [-1.2, 0.8, -2.3, ...],  // 费用率超支（百分点）
            lineStyle: { color: '#0070c0', width: 2 },
            label: {
                show: true,
                position: 'top',
                formatter: (p) => `${p.value >= 0 ? '+' : ''}${formatRate(p.value, 1)}%`,
                color: '#0070c0'
            },
            markLine: {
                data: [{
                    yAxis: 0,
                    name: '费用率阈值线',
                    lineStyle: { color: '#ffc000', type: 'dashed', width: 2 },
                    label: { formatter: '14%阈值线' }
                }]
            }
        }
    ]
};

// 投产效率分析组合图数据结构（2025-12-22新增）
roiChartData = {
    categories: ['天府', '新都', '高新', '武侯', ...],
    series: [
        {
            name: '费用产出保费比',
            type: 'bar',
            yAxisIndex: 0,
            data: [5.21, 4.67, 6.02, ...]
        },
        {
            name: '费用产出边际贡献',
            type: 'bar',
            yAxisIndex: 0,
            data: [1.35, -0.42, 1.08, ...]  // 负值需红色标识
        },
        {
            name: '边际贡献率',
            type: 'line',
            yAxisIndex: 1,
            data: [18.5, 12.3, 24.1, ...]
        }
    ]
};
```

## 交互设计

### 1. 维度切换机制
```javascript
switchDimension('expense', dimension) {
    this.currentDimensions.expense = dimension;
    this.renderChart('expense');
}
```

### 2. 投产效率维度切换机制
```javascript
switchROIDimension(dimension) {
    this.currentDimensions.roi = dimension;
    this.renderROIChart();
}
```

### 3. 费用率颜色判断
```javascript
getExpenseRateColor(expenseRate) {
    if (expenseRate > 17) return '#c00000';      // 危险红色
    else if (expenseRate > 14) return '#ffc000'; // 预警橙色
    else return '#00b050';                       // 正常绿色
}
```

### 4. 数据提示框设计
```javascript
tooltip: {
    trigger: 'axis',
    formatter: (params) => {
        const p = params?.[0];
        if (!p) return '';
        
        const dimension = p.axisValue;
        const rate = this.formatRate(p.data.actual, 1);
        const amount = this.formatWanYuanFromYuan(p.data.amount || 0);
        
        return `${dimension}<br/>
                费用率: ${rate}%<br/>
                费用金额: ${amount}万元`;
    }
}
```

// 投产效率分析图 tooltip 示例（维度+三指标）
```javascript
roiTooltip: {
    trigger: 'axis',
    formatter: (params) => {
        const dimension = params?.[0]?.axisValue;
        return `${dimension}<br/>
                费用产出保费比: ${params[0].value}元<br/>
                费用产出边际贡献: ${params[1].value}元<br/>
                边际贡献率: ${params[2].value}%`;
    }
}
```

### 5. 全局样式规范统一（2025-12-22优化）
```javascript
// 全局图表配置优化
getGlobalChartOptions() {
    return {
        // 移除网格线
        grid: {
            show: false, // 移除所有网格线
            // ...其他配置
        },
        // 线条宽度减半
        lineStyle: {
            width: 1 // 所有折线宽度从2px减为1px
        },
        // 坐标轴线宽度减半
        xAxis: {
            axisLine: { lineStyle: { width: 1 } },
            splitLine: { show: false }
        },
        yAxis: {
            axisLine: { lineStyle: { width: 1 } },
            splitLine: { show: false }
        }
    };
}
```

**优化效果**：
- 视觉精细度提升：折线更细腻，专业感增强
- 界面简洁性：移除网格线，数据更突出
- 一致性保证：所有图表遵循统一的视觉规范

### 6. 极值处理逻辑
```javascript
normalizeExpenseRates(values) {
    const sortedValues = [...values].sort((a, b) => b - a);
    const maxValue = sortedValues[0];
    const secondMaxValue = sortedValues[1] || maxValue;
    
    // 如果最大值超过第二最大值的2倍，进行限制
    if (values.length > 1 && maxValue > secondMaxValue * 2) {
        const limitMax = secondMaxValue * 2;
        return values.map(value => value > limitMax ? limitMax : value);
    }
    
    return values;
}
```

## 样式规范

### 1. 图表容器样式
```css
#chart-expense {
    height: 500px;
    width: 100%;
}

#chart-roi {
    height: 500px;
    width: 100%;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--card-shadow);
}
```

### 2. 柱状图样式配置
```javascript
{
    type: 'bar',
    barWidth: '60%',                    // 柱子宽度
    itemStyle: {
        borderColor: 'rgba(255, 255, 255, 0.8)',
        borderWidth: 1,
        borderRadius: [4, 4, 0, 0]     // 顶部圆角
    },
    emphasis: {
        itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.2)'
        }
    }
}
```

### 3. 数据标签样式
```javascript
label: {
    show: true,
    position: 'top',
    distance: 8,
    formatter: (p) => `${this.formatRate(p.data.actual, 1)}%`,
    color: '#333333',
    fontSize: 14,
    fontWeight: '600',
    textBorderColor: 'rgba(255, 255, 255, 0.8)',
    textBorderWidth: 2
}
```

### 4. 预警线样式
```javascript
markLine: {
    silent: false,                     // 支持交互
    symbol: ['none', 'none'],         // 不显示端点
    lineStyle: {
        color: '#ffc000',
        type: 'dashed',
        width: 2
    },
    label: {
        show: true,
        position: 'end',
        formatter: '{b}: {c}%',
        color: '#ffc000',
        fontSize: 12,
        fontWeight: '600'
    }
}
```

## 业务规则

### 1. 费用率计算规则
- **基础公式**: 费用率 = 费用金额 / 签单保费 × 100%
- **精度要求**: 保留1位小数
- **除零保护**: 签单保费为0时费用率设为0

### 2. 投产效率指标规则
- **费用产出保费比**: 签单保费 / 费用额，保留2位小数
- **费用产出边际贡献**: 边际贡献额 / 费用额，保留2位小数（可为负值）
- **边际贡献率**: 边际贡献额 / 签单保费 × 100%，保留1位小数
- **边际贡献额**: 签单保费 × (1 - 已报告赔款/满期保费 - 费用额/签单保费)
- **除零保护**: 费用额或签单保费为0时不参与投产效率图；满期保费为0时边际贡献相关指标设为0

### 3. 预警阈值规则
```javascript
const expenseThresholds = {
    normal: 14,        // 正常上限
    warning: 17,       // 危险上限
    colors: {
        good: '#00b050',      // 正常绿色
        warning: '#ffc000',   // 预警橙色
        danger: '#c00000'     // 危险红色
    }
};
```

### 4. 数据处理规则
- **空值处理**: 过滤掉费用金额或签单保费为空的数据
- **负值处理**: 费用金额为负数时取绝对值并记录警告
- **异常值**: 费用率超过100%时限制为100%并记录警告
- **边际贡献为负**: 保留数据并在投产效率图中红色标注

### 5. 排序规则
- **主排序**: 按费用金额降序排列（柱状图从高到低）
- **次排序**: 费用率降序排列（相同费用金额时）
- **稳定性**: 排序结果保持稳定，相同值保持原有顺序
- **投产效率**: 同样按费用金额降序，确保对比一致性

## 性能优化

### 1. 数据缓存机制
```javascript
// 缓存聚合结果
this._expenseDataCache = new Map();

getCachedExpenseData(dimension, filters) {
    const cacheKey = `${dimension}_${JSON.stringify(filters)}`;
    
    if (!this._expenseDataCache.has(cacheKey)) {
        const data = this.processExpenseData(dimension, filters);
        this._expenseDataCache.set(cacheKey, data);
    }
    
    return this._expenseDataCache.get(cacheKey);
}
```

### 2. 渲染优化
```javascript
// 防抖渲染
this.debouncedRenderExpenseChart = this.debounce(() => {
    this._renderExpenseChartInternal();
}, 100);

// 按需渲染
renderChart(tab) {
    if (tab === 'expense' && !this._expenseChartInitialized) {
        this._expenseChartInitialized = true;
        this.initExpenseChart();
    }
    
    this.debouncedRenderExpenseChart();
}
```

### 3. 内存管理
```javascript
// 清理过期缓存
clearExpenseCache() {
    if (this._expenseDataCache.size > 50) {
        const keysToDelete = Array.from(this._expenseDataCache.keys()).slice(0, 25);
        keysToDelete.forEach(key => this._expenseDataCache.delete(key));
    }
}
```

## 扩展性设计

### 1. 费用类型扩展
```javascript
const expenseTypes = {
    total: '总费用',
    marketing: '营销费用', 
    operation: '运营费用',
    admin: '管理费用'
    // 支持扩展新的费用类型
};
```

### 2. 预警线配置扩展
```javascript
const warningLineConfigs = {
    default: {
        value: 14,
        color: '#ffc000',
        type: 'dashed'
    },
    strict: {
        value: 12,
        color: '#ff6b6b',
        type: 'solid'
    }
    // 支持不同的预警标准
};
```

### 3. 分析维度扩展
```javascript
const expenseDimensions = {
    org: 'third_level_organization',
    category: 'ui_customer_category',
    businessType: 'ui_short_label',
    channel: 'terminal_source',      // 新增渠道维度
    vehicleType: 'vehicle_type'      // 新增车型维度
};
```

## 配置管理

### 1. 阈值配置
```javascript
const expenseConfig = {
    thresholds: {
        normal: 14,
        warning: 17,
        danger: 20
    },
    colors: {
        normal: '#00b050',
        warning: '#ffc000', 
        danger: '#c00000'
    },
    display: {
        decimalPlaces: 1,
        showWarningLine: true,
        normalizeExtremeValues: true
    }
};
```

### 2. 图表配置
```javascript
const chartOptions = {
    height: 500,
    barWidth: '60%',
    animationDuration: 800,
    tooltipDelay: 50,
    enableDataZoom: false,
    showLegend: false
};
```

## 错误处理

### 1. 数据异常处理
```javascript
processExpenseData(data) {
    const validData = data.filter(row => {
        // 验证必需字段
        if (!row.签单保费 || row.签单保费 <= 0) {
            console.warn('无效的签单保费数据', row);
            return false;
        }
        
        // 验证费用金额
        if (!row.费用金额 || row.费用金额 < 0) {
            console.warn('无效的费用金额数据', row);
            return false;
        }
        
        return true;
    });
    
    return validData;
}
```

### 2. 渲染异常处理
```javascript
renderExpenseChart() {
    try {
        const chartData = this.prepareExpenseChartData();
        this.chart.setOption(chartData, true);
    } catch (error) {
        console.error('费用图表渲染失败:', error);
        
        // 回退到空状态
        this.showEmptyState('费用数据加载失败');
        
        // 尝试重新初始化
        setTimeout(() => this.initExpenseChart(), 1000);
    }
}
```

## 测试要点

### 1. 数据准确性测试
- 验证费用率计算公式正确性
- 验证聚合汇总逻辑正确性
- 验证排序规则正确性
- 验证投产效率三指标计算公式正确性

### 2. 状态颜色测试
- 验证三个颜色区间的边界值
- 验证颜色变化逻辑正确性
- 验证颜色在不同数据下的稳定性
- 验证边际贡献为负时红色标识

### 3. 交互功能测试
- 验证维度切换响应性
- 验证提示框信息完整性
- 验证预警线显示正确性
- 验证投产效率维度切换与费用支出一致

### 4. 性能测试
- 测试大数据量下的渲染性能
- 测试频繁切换维度的响应速度
- 测试内存使用情况

### 5. 边界情况测试
- 测试空数据情况的处理
- 测试极端值的处理效果
- 测试异常数据的过滤效果
- 测试边际贡献为负与费用额/签单保费为0的处理
