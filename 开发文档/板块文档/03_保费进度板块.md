# 保费进度板块详细文档

## 模块概述
保费进度板块专注于分析各维度的保费收入情况，通过柱状图直观展示保费规模的对比关系，支持三级机构/客户类别/业务类型三个维度的切换分析。

## 核心功能

### 1. 维度分析系统
- **三级机构**: 按天府、新都、高新等分支机构分析保费分布
- **客户类别**: 按个人客户、团体客户等类别分析保费构成
- **业务类型**: 按非营业客车、营业货车等业务类型分析保费规模

### 2. 数据展示特性
- **图表类型**: 单系列柱状图
- **数据指标**: 签单保费（单位：万元）
- **状态颜色**: 基于变动成本率的三色预警系统
- **排序规则**: 按签单保费降序排列
- **核心指标**:
  - 签单保费(万元) = 维度签单保费汇总 ÷ 10000
  - 变动成本率(%) = 满期赔付率 + 费用率（用于柱状图颜色判断）

## 数据处理逻辑

### 1. 维度字段映射
```javascript
const dimensionMapping = {
    'org': 'third_level_organization',
    'category': 'ui_customer_category',
    'businessType': 'ui_short_label'
};
```

### 2. 数据聚合流程
1. **分组**: 按`dimensionField`对原始数据进行分组
2. **保费汇总**: 计算每组的签单保费总额
3. **成本率计算**: 计算每组的变动成本率用于状态着色
4. **排序**: 按签单保费降序排列（柱状图从高到低）
5. **极值处理**: 对极端保费值进行归一化处理

### 3. 图表数据结构
```javascript
chartData = {
    categories: ['天府', '新都', '高新', '武侯', ...],
    series: [{
        name: '签单保费',
        type: 'bar',
        data: [
            { 
                value: 85.2,           // 归一化后的值
                actual: 2856,         // 实际值(万元)
                itemStyle: { color: '#00b050' }  // 基于变动成本率的状态色
            },
            ...
        ]
    }]
};
```

## 交互设计

### 1. 维度切换机制
```javascript
switchDimension('premium', dimension) {
    this.currentDimensions.premium = dimension;
    this.renderChart('premium');  // 重新渲染图表
}
```

### 2. 数据提示框
- **基础信息**: 维度名称 + 签单保费金额
- **格式化**: 保费金额以万元为单位，千分位分隔
- **定位**: 跟随鼠标，显示在合适位置

### 3. 状态颜色系统
```javascript
getStatusColor(costRate) {
    if (costRate > 94) return '#c00000';      // 危险红色
    else if (costRate > 91) return '#ffc000'; // 预警橙色  
    else return '#00b050';                     // 正常绿色
}
```

## 样式规范

### 1. 图表容器
```css
#chart-premium {
    height: 500px;
    width: 100%;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--card-shadow);
}
```

### 2. 维度切换按钮
```css
.dimension-btn {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(160, 39, 36, 0.2);
    border-radius: var(--border-radius-sm);
    padding: 8px 16px;
    transition: var(--transition);
}

.dimension-btn.active {
    background: var(--primary-red);
    color: white;
    border-color: var(--primary-red);
}
```

### 3. 数据标签
```css
.label-style {
    show: true;
    position: 'top';
    formatter: (p) => `${this.formatInteger(p.data.actual)}`;
    color: '#333333';
    font-size: 14px;
    font-weight: 600;
}
```

## 性能优化

### 1. 极值归一化处理
```javascript
normalizeBarHeights(values) {
    const sortedValues = [...values].sort((a, b) => b - a);
    const maxValue = sortedValues[0];
    const secondMaxValue = sortedValues[1] || maxValue;
    
    // 如果最大值超过第二最大值的2倍，进行限制
    if (maxValue > secondMaxValue * 2) {
        const limitMax = secondMaxValue * 2;
        return values.map(value => value > limitMax ? limitMax : value);
    }
    
    return values;
}
```

### 2. 数据缓存机制
- 聚合结果缓存在`this._chartDataCache`
- 相同维度和筛选条件时直接返回缓存结果
- 筛选条件变化时自动清除相关缓存

### 3. 防抖渲染
```javascript
this.debouncedRenderChart = this.debounce((tab) => {
    this._renderChartInternal(tab);
}, 100);
```

## 业务规则

### 1. 保费计算规则
- **数据源**: CSV/Excel文件中的签单保费字段
- **单位转换**: 元转换为万元（÷10000）
- **汇总方式**: 按维度分组求和

### 2. 状态判断规则
- **正常**: 变动成本率 ≤ 91%
- **预警**: 91% < 变动成本率 ≤ 94%  
- **危险**: 变动成本率 > 94%

### 3. 排序规则
- **主排序**: 按签单保费降序
- **次排序**: 按维度名称升序（保费相等时）

## 配置参数

### 1. 预警阈值配置
```javascript
const thresholds = {
    costRateWarning: 91,    // 变动成本率预警线
    costRateDanger: 94      // 变动成本率危险线
};
```

### 2. 图表配置参数
```javascript
const chartConfig = {
    height: 500,                    // 图表高度
    maxBarRatio: 2.0,              // 最大柱子高度比例
    animationDuration: 800,         // 动画时长
    tooltipDelay: 50               // 提示框延迟
};
```

## 扩展性设计

### 1. 维度扩展
- 新增维度只需在`dimensionMapping`中添加映射关系
- 维度标签支持国际化配置
- 维度显示顺序可配置

### 2. 指标扩展
- 支持添加其他保费相关指标（如标准保费、续保保费等）
- 指标计算逻辑模块化，便于维护
- 指标展示格式可配置

### 3. 交互扩展
- 支持柱子点击钻取到明细数据
- 支持时间段对比分析
- 支持自定义排序规则

## 错误处理

### 1. 数据异常处理
- **空值**: 过滤掉签单保费为空或0的数据
- **负值**: 记录警告日志但不显示
- **超大数据**: 自动归一化处理并记录日志

### 2. 渲染异常处理
- **图表初始化失败**: 显示错误提示，尝试重新初始化
- **数据格式错误**: 回退到默认数据，记录错误信息
- **内存不足**: 清理缓存，简化渲染

## 测试要点

### 1. 数据准确性测试
- 验证保费汇总计算正确性
- 验证变动成本率计算正确性
- 验证排序逻辑正确性

### 2. 交互功能测试
- 验证维度切换响应及时性
- 验证提示框内容准确性
- 验证状态颜色显示正确性

### 3. 性能测试
- 测试大数据量下的渲染性能
- 测试频繁切换维度的响应速度
- 测试内存使用情况