# agent.md（开发文档/板块文档）

## 1. 本文件夹是什么
本文件夹用于定义“仪表板各分析板块”的产品口径、图表形态、交互与验证要点。
这些文档用于约束实现侧（主要在 /js/）的行为一致性：同一指标、同一阈值、同一维度切换，在所有板块中必须口径一致。

本文件夹包含的板块文档（示例）：
- 00_UI设计.md
- 01_指标体系.md
- 02_经营概览板块.md
- 03_保费进度板块.md
- 04_变动成本板块.md
- 05_损失暴露板块.md
- 06_费用支出板块.md
- 07_筛选器系统.md

## 2. 权威层级（冲突时谁说了算）
1) 本文件夹内的板块文档（各板块口径与交互）
2) 全局筛选器系统文档（07_筛选器系统.md）
3) 代码实现（/js/…）

注意：
- 若发现“代码行为与板块文档不一致”，优先修正代码；除非你明确要求更新文档并解释取舍。
- 任何阈值/映射/规则不允许在代码中散落硬编码；应集中配置（若你的仓库已有 reference/，以 reference 为准）。

## 3. Agent 在本文件夹工作的标准路径（必须遵守）
1) 先定位目标板块文档：明确它定义了什么图表、什么口径、什么阈值、什么维度切换。
2) 再对照筛选器系统：确认维度 key、筛选状态、级联锁定是否会影响本板块展示与计算。参考 07_筛选器系统.md。  
3) 最后再去代码侧定位对应实现点（通常是“数据聚合/图表渲染/维度切换/tooltip”四类）。
4) 改动后必须给出验证闭环（见第 5 节）。

## 4. 板块文档的“统一约束”（跨板块一致性）
### 4.1 维度切换一致性
板块维度切换必须支持并仅支持文档定义的维度集合（如：三级机构/客户类别/业务类型）。
维度字段映射需使用统一 mapping（例如 org/category/businessType 对应字段）。各板块文档内如有 mapping，必须一致。

### 4.2 指标口径一致性
同名指标在不同板块必须同口径计算，不得出现：
- 分母不一致（例如签单保费 vs 满期保费混用）
- 单位不一致（元/万元混用）
- 小数精度不一致（保留位数不统一）

### 4.3 排序与可读性
若文档写明“按签单保费降序”，则实现必须遵守；并避免排序不稳定导致图表频繁跳动。

---

## 5. 06_费用支出板块：强约束清单（实现必须对齐）
（本节用于指导 Agent 在实现/排错时快速定位“什么必须一致”。）

### 5.1 图表形态
- 单系列柱状图
- 柱顶显示费用率百分比标签（保留 1 位小数）  
- 支持按【三级机构 / 客户类别 / 业务类型】切换分析维度

依据：06_费用支出板块.md（模块概述与核心功能）。  

### 5.2 费用率口径（不可变）
费用率(%) = 费用金额 / 签单保费 × 100%

边界：
- 签单保费为 0：费用率按 0 处理（除零保护）
- 精度：保留 1 位小数

依据：06_费用支出板块.md（业务规则：费用率计算规则）。  

### 5.3 三色预警阈值（不可擅改）
- 正常：费用率 ≤ 14%
- 预警：14% < 费用率 ≤ 17%
- 危险：费用率 > 17%
并包含一条 14% 预警线（橙色虚线），带标签“预警线: 14%”。

依据：06_费用支出板块.md（三色预警机制、预警线系统）。  

### 5.4 维度字段映射（必须使用一致 key）
- org -> third_level_organization
- category -> ui_customer_category
- businessType -> ui_short_label

依据：06_费用支出板块.md（维度字段映射）。  

### 5.5 排序规则（不可省略）
- 主排序：按签单保费降序
- 次排序：相同保费时按费用率降序（文档要求“相同保费时”）
- 稳定性：相同值保持原顺序，避免图表抖动

依据：06_费用支出板块.md（排序规则）。  

### 5.6 极值处理与异常处理（必须保留）
- 若最大费用率 > 第二大费用率的 2 倍，进行上限截断（用于可视化可读性）
- 费用金额为负：取绝对值并记录警告（不静默吞掉）
- 费用率 > 100%：限制为 100% 并记录警告

依据：06_费用支出板块.md（极值处理逻辑、数据处理规则）。  

### 5.7 交互（维度切换函数形态）
切换逻辑遵循：
switchDimension('expense', dimension) -> 更新 currentDimensions.expense -> renderChart('expense')

依据：06_费用支出板块.md（维度切换机制）。  

### 5.8 tooltip 必含字段
tooltip 至少包含：
- 维度名称
- 费用率（%）
- 费用金额（万元格式化）

依据：06_费用支出板块.md（数据提示框设计）。  

---

## 6. 与“筛选器系统”的耦合点（Agent 必须留意）
费用支出板块的聚合与展示必须受到全局筛选器 applied/draft 状态影响，并与“级联锁定”规则保持一致（例如业务类型触发对续保状态/过户等的锁定或排除逻辑）。  
若出现“费用板块与其他板块筛选结果不一致”，优先排查筛选器状态机与 appliedFilters 的收集/应用流程。

依据：07_筛选器系统详细文档（filterState、applyDrillFilters、级联锁定等）。  

---

## 7. 交付与验证（每次修改后必须输出）
必须输出以下内容，便于你快速审阅：
1) 改动涉及的板块与条款编号（例如：5.2/5.3/5.5）
2) 修改文件清单（新增/修改/删除）
3) 可复现验证步骤：
   - 导入一份含“费用金额/签单保费”的数据
   - 切换维度（org/category/businessType）至少各 1 次
   - 验证：费用率公式正确、颜色阈值正确、14% 预警线存在、排序符合规则、tooltip 信息齐全
4) 风险与回滚方式（回滚哪个文件、回滚到哪个行为）
