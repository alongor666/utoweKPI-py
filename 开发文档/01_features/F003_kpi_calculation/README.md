# F003: KPI计算引擎

## 功能描述

核心业务指标计算引擎，支持多种KPI公式和阈值告警，为经营分析提供量化依据。

## 实现逻辑

### 核心KPI公式

```python
def calculate_kpis(data):
    """KPI计算核心算法"""
    for row in data:
        premium = float(row.get('保费收入', 0))
        cost = float(row.get('变动成本', 0))
        claims = float(row.get('赔款支出', 0))
        
        # 基础KPI
        row['成本率'] = cost / premium if premium > 0 else 0
        row['赔付率'] = claims / premium if premium > 0 else 0
        row['综合成本率'] = (cost + claims) / premium if premium > 0 else 0
        
        # 时间进度
        week_num = int(row.get('周次', 1))
        row['时间进度'] = week_num / 52
```

### 配置化阈值
- **文件**: `reference/thresholds.json`
- **功能**: 定义各KPI的告警阈值
- **支持**: 多级阈值和动态调整

## 核心特性

1. **实时计算**: 数据变化即时反映到KPI
2. **容错处理**: 除零保护和异常值处理
3. **配置化**: 阈值和公式可通过配置文件调整
4. **多维度**: 支持按业务类型、时间等维度分组计算

## KPI指标体系

### 基础指标
- **保费收入**: 总保费和分类保费
- **成本支出**: 变动成本和固定成本
- **赔款支出**: 已决和未决赔款

### 衍生指标
- **成本率**: 变动成本 / 保费收入
- **赔付率**: 赔款支出 / 保费收入
- **综合成本率**: (变动成本 + 赔款支出) / 保费收入
- **时间进度**: 当前周次 / 年度总周数

## 配置示例

```json
{
  "thresholds": {
    "成本率": {
      "warning": 0.15,
      "critical": 0.20
    },
    "赔付率": {
      "warning": 0.60,
      "critical": 0.70
    },
    "综合成本率": {
      "warning": 0.75,
      "critical": 0.85
    }
  }
}
```

## 依赖关系

- **F002**: 业务类型映射 (接收标准化数据)
- **F004**: 数据聚合器 (提供聚合后的KPI)

## 性能优化

1. **向量化计算**: 使用numpy进行批量计算
2. **缓存机制**: 重复计算结果缓存
3. **并行处理**: 多线程处理大数据集

## 测试要点

1. **计算准确性**: 与手工计算结果对比
2. **边界条件**: 零值、负数、异常值处理
3. **性能测试**: 大数据量计算时间
4. **配置验证**: 阈值配置的正确性

## 维护说明

- 定期验证KPI公式的业务准确性
- 根据业务调整更新阈值配置
- 监控计算性能和异常情况

---

> 此功能是整个系统的核心，确保业务指标的准确性和实时性。