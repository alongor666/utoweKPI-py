# F004: 数据聚合与统计

## 功能描述

多维度数据聚合统计，支持按业务类型、时间等维度汇总，为报告生成提供数据基础。

## 实现逻辑

### 聚合算法
```python
def aggregate_data(data):
    """数据聚合核心算法"""
    aggregated = {
        'total': {'保费收入': 0, '变动成本': 0, '赔款支出': 0, '保单件数': 0},
        'byBusinessType': {},
        'byWeek': {}
    }
    
    for row in data:
        # 总量聚合
        _aggregate_total(aggregated['total'], row)
        
        # 按业务类型聚合
        _aggregate_by_type(aggregated['byBusinessType'], row)
        
        # 按时间聚合
        _aggregate_by_week(aggregated['byWeek'], row)
    
    return aggregated
```

### 多维度支持
- **总量汇总**: 全局指标汇总
- **业务类型**: 按险种分类统计
- **时间维度**: 按周/月/年统计
- **机构维度**: 按分公司统计

## 核心特性

1. **多维度聚合**: 支持任意维度组合
2. **实时计算**: 数据变化即时反映
3. **内存优化**: 流式处理大数据集
4. **扩展性**: 易于添加新的聚合维度

## 聚合维度

### 业务类型维度
```javascript
byBusinessType: {
  "个人车险": {
    "保费收入": 1000000,
    "变动成本": 150000,
    "赔款支出": 600000,
    "保单件数": 500
  },
  "商业车险": {
    "保费收入": 2000000,
    "变动成本": 300000,
    "赔款支出": 1200000,
    "保单件数": 200
  }
}
```

### 时间维度
```javascript
byWeek: {
  "第49周": {
    "保费收入": 500000,
    "变动成本": 75000,
    "赔款支出": 300000,
    "保单件数": 100
  },
  "第50周": {
    "保费收入": 600000,
    "变动成本": 90000,
    "赔款支出": 360000,
    "保单件数": 120
  }
}
```

## 依赖关系

- **F003**: KPI计算引擎 (接收计算后的KPI数据)
- **F005**: 报告生成器 (提供聚合数据)

## 性能优化

1. **增量聚合**: 只处理变化的数据
2. **并行计算**: 多线程处理不同维度
3. **内存管理**: 分批处理避免内存溢出
4. **索引优化**: 使用高效的数据结构

## 测试要点

1. **聚合准确性**: 与手工汇总结果对比
2. **性能测试**: 大数据量聚合时间
3. **内存测试**: 内存使用情况监控
4. **维度测试**: 各维度聚合的正确性

## 维护说明

- 监控聚合性能和内存使用
- 根据业务需求添加新的聚合维度
- 优化聚合算法提升处理速度

---

> 此功能为报告生成提供数据基础，确保统计结果的准确性和及时性。